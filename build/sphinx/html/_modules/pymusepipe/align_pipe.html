

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>pymusepipe.align_pipe &mdash; pymusepipe 2.9.9.post16 documentation</title>
  

  
  
  
  

  
  <script type="text/javascript" src="../../_static/js/modernizr.min.js"></script>
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/jquery.js"></script>
        <script src="../../_static/underscore.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/language_data.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> pymusepipe
          

          
          </a>

          
            
            
              <div class="version">
                2.9.9.post16
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <ul>
<li class="toctree-l1"><a class="reference internal" href="../../howto.html">HowTo</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../license.html">License</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../authors.html">Authors</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../changelog.html">Changelog</a></li>
<li class="toctree-l1"><a class="reference internal" href="../../api/modules.html">Module Reference</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">pymusepipe</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html">Docs</a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>pymusepipe.align_pipe</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for pymusepipe.align_pipe</h1><div class="highlight"><pre>
<span></span><span class="c1"># Licensed under a MIT license - see LICENSE</span>

<span class="sd">&quot;&quot;&quot;MUSE-PHANGS alignement module. This module can be used to align MUSE</span>
<span class="sd">reconstructed images either with each others or using a reference background</span>
<span class="sd">image. It spits the results out in a Fits table which can then be used</span>
<span class="sd">to process and mosaic Muse PIXTABLES. It includes a normalisation factor,</span>
<span class="sd">an estimate of the background, as well as any potential rotation. Fine tuning</span>
<span class="sd">can be done by hand by the user, using a set of reference plots.</span>
<span class="sd">&quot;&quot;&quot;</span>

<span class="n">__authors__</span>   <span class="o">=</span> <span class="s2">&quot;Eric Emsellem&quot;</span>
<span class="n">__copyright__</span> <span class="o">=</span> <span class="s2">&quot;(c) 2017, ESO + CRAL&quot;</span>
<span class="n">__license__</span>   <span class="o">=</span> <span class="s2">&quot;MIT License&quot;</span>
<span class="n">__contact__</span>   <span class="o">=</span> <span class="s2">&quot; &lt;eric.emsellem@eso.org&gt;&quot;</span>

<span class="c1"># Import general modules</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">os.path</span> <span class="kn">import</span> <span class="n">join</span> <span class="k">as</span> <span class="n">joinpath</span>

<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">copy</span>

<span class="c1"># Import Matplotlib</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>

<span class="c1"># Import Numpy Scipy</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage</span> <span class="k">as</span> <span class="nn">nd</span>
<span class="kn">from</span> <span class="nn">scipy.signal</span> <span class="kn">import</span> <span class="n">correlate</span>
<span class="kn">from</span> <span class="nn">scipy.odr</span> <span class="kn">import</span> <span class="n">ODR</span><span class="p">,</span> <span class="n">Model</span><span class="p">,</span> <span class="n">RealData</span>

<span class="c1"># Astropy</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">wcs</span> <span class="k">as</span> <span class="n">awcs</span>
<span class="kn">from</span> <span class="nn">astropy.io</span> <span class="kn">import</span> <span class="n">fits</span> <span class="k">as</span> <span class="n">pyfits</span>
<span class="kn">from</span> <span class="nn">astropy.modeling</span> <span class="kn">import</span> <span class="n">models</span><span class="p">,</span> <span class="n">fitting</span>
<span class="kn">from</span> <span class="nn">astropy.stats</span> <span class="kn">import</span> <span class="n">mad_std</span>
<span class="kn">from</span> <span class="nn">astropy.table</span> <span class="kn">import</span> <span class="n">Table</span><span class="p">,</span> <span class="n">Column</span>
<span class="kn">from</span> <span class="nn">astropy</span> <span class="kn">import</span> <span class="n">units</span> <span class="k">as</span> <span class="n">u</span>
<span class="kn">from</span> <span class="nn">astropy.convolution</span> <span class="kn">import</span> <span class="n">Gaussian2DKernel</span><span class="p">,</span> <span class="n">convolve</span>

<span class="c1"># Import mpdaf</span>
<span class="kn">from</span> <span class="nn">mpdaf.obj</span> <span class="kn">import</span> <span class="n">Image</span><span class="p">,</span> <span class="n">WCS</span>


<div class="viewcode-block" id="is_sequence"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.is_sequence">[docs]</a><span class="k">def</span> <span class="nf">is_sequence</span><span class="p">(</span><span class="n">arg</span><span class="p">):</span>
    <span class="k">return</span> <span class="p">(</span><span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;strip&quot;</span><span class="p">)</span> <span class="ow">and</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__getitem__&quot;</span><span class="p">)</span> <span class="ow">or</span>
            <span class="nb">hasattr</span><span class="p">(</span><span class="n">arg</span><span class="p">,</span> <span class="s2">&quot;__iter__&quot;</span><span class="p">))</span></div>


<span class="c1"># Import needed modules from pymusepipe</span>
<span class="kn">from</span> <span class="nn">.</span> <span class="kn">import</span> <span class="n">util_pipe</span> <span class="k">as</span> <span class="n">upipe</span>
<span class="kn">from</span> <span class="nn">.config_pipe</span> <span class="kn">import</span> <span class="n">mjd_names</span><span class="p">,</span> <span class="n">date_names</span><span class="p">,</span> <span class="n">tpl_names</span>
<span class="kn">from</span> <span class="nn">.config_pipe</span> <span class="kn">import</span> <span class="n">pointing_names</span><span class="p">,</span> <span class="n">iexpo_names</span>
<span class="kn">from</span> <span class="nn">.config_pipe</span> <span class="kn">import</span> <span class="n">default_offset_table</span><span class="p">,</span> <span class="n">dict_listObject</span>

<span class="c1"># ================== Default units ======================== #</span>
<span class="c1"># Define useful units</span>
<span class="n">default_muse_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">erg</span> <span class="o">/</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">cm</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">second</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)</span> <span class="o">*</span> <span class="mf">1.e-20</span>
<span class="n">default_reference_unit</span> <span class="o">=</span> <span class="n">u</span><span class="o">.</span><span class="n">microJansky</span>

<span class="n">dict_equivalencies</span> <span class="o">=</span> <span class="p">{</span><span class="s2">&quot;WFI_BB&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">spectral_density</span><span class="p">(</span><span class="mf">6483.58</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">),</span>
                   <span class="s2">&quot;DUPONT_R&quot;</span><span class="p">:</span> <span class="n">u</span><span class="o">.</span><span class="n">spectral_density</span><span class="p">(</span><span class="mf">6483.58</span> <span class="o">*</span> <span class="n">u</span><span class="o">.</span><span class="n">AA</span><span class="p">)}</span>

<span class="c1"># ================== Useful function ====================== #</span>
<div class="viewcode-block" id="create_offset_table"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.create_offset_table">[docs]</a><span class="k">def</span> <span class="nf">create_offset_table</span><span class="p">(</span><span class="n">image_names</span><span class="o">=</span><span class="p">[],</span> <span class="n">table_folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> 
        <span class="n">table_name</span><span class="o">=</span><span class="s2">&quot;dummy_offset_table.fits&quot;</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Create an offset list table from a given set of images. It will use</span>
<span class="sd">    the MJD and DATE as read from the descriptors of the images. The names for</span>
<span class="sd">    these keywords is stored in the dictionary default_offset_table from</span>
<span class="sd">    config_pipe.py</span>

<span class="sd">    Args:</span>
<span class="sd">        image_names (list of str): List of image names to be considered.</span>
<span class="sd">        table_folder (str): folder of the table</span>
<span class="sd">        table_name (str): name of the table to save [&#39;dummy_offset_table.fits&#39;]</span>
<span class="sd">        overwrite (bool): if the table exists, it will be overwritten if set</span>
<span class="sd">            to True only. [False]</span>

<span class="sd">    Creates:</span>
<span class="sd">        A fits table with the output given name.</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># Check if table exists and see if overwrite is set up</span>
    <span class="n">table_fullname</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">table_folder</span><span class="p">,</span> <span class="n">table_name</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">overwrite</span> <span class="ow">and</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">table_fullname</span><span class="p">):</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;[create_offset_table] Table </span><span class="si">{0}</span><span class="s2"> &quot;</span>
                            <span class="s2">&quot;already exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">table_fullname</span><span class="p">))</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Use overwrite=True if you wish to proceed&quot;</span><span class="p">)</span>
        <span class="k">return</span> 

    <span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">image_names</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">nimages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;No image names provided for create_offset_table&quot;</span><span class="p">)</span>
        <span class="k">return</span>

    <span class="c1"># Gather the values of DATE and MJD from the images</span>
    <span class="n">date</span><span class="p">,</span> <span class="n">mjd</span><span class="p">,</span> <span class="n">tpls</span><span class="p">,</span> <span class="n">iexpo</span><span class="p">,</span> <span class="n">pointing</span> <span class="o">=</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[],</span> <span class="p">[]</span>
    <span class="k">for</span> <span class="n">ima</span> <span class="ow">in</span> <span class="n">image_names</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">ima</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;[create_offset] Image </span><span class="si">{0}</span><span class="s2"> does not exists&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">ima</span><span class="p">))</span>
            <span class="k">continue</span>

        <span class="n">head</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">getheader</span><span class="p">(</span><span class="n">ima</span><span class="p">)</span>
        <span class="n">date</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">date_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">mjd</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">tpls</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">tpl_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">iexpo</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">iexpo_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>
        <span class="n">pointing</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">head</span><span class="p">[</span><span class="n">pointing_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]])</span>

    <span class="n">nlines</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">date</span><span class="p">)</span>

    <span class="c1"># Create and fill the table</span>
    <span class="n">offset_table</span> <span class="o">=</span> <span class="n">Table</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">col</span> <span class="ow">in</span> <span class="n">default_offset_table</span><span class="p">:</span>
        <span class="p">[</span><span class="n">name</span><span class="p">,</span> <span class="n">form</span><span class="p">,</span> <span class="n">default</span><span class="p">]</span> <span class="o">=</span> <span class="n">default_offset_table</span><span class="p">[</span><span class="n">col</span><span class="p">]</span>
        <span class="n">offset_table</span><span class="p">[</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="n">Column</span><span class="p">([</span><span class="n">default</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nlines</span><span class="p">)],</span> 
                                    <span class="n">dtype</span><span class="o">=</span><span class="n">form</span><span class="p">)</span>

    <span class="n">offset_table</span><span class="p">[</span><span class="n">date_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">date</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">mjd</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">tpl_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">tpls</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">iexpo_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">iexpo</span>
    <span class="n">offset_table</span><span class="p">[</span><span class="n">pointing_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="n">pointing</span>

    <span class="c1"># Write the table</span>
    <span class="n">offset_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">table_fullname</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span></div>


<div class="viewcode-block" id="open_new_wcs_figure"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.open_new_wcs_figure">[docs]</a><span class="k">def</span> <span class="nf">open_new_wcs_figure</span><span class="p">(</span><span class="n">nfig</span><span class="p">,</span> <span class="n">mywcs</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Open a new figure (with number nfig) with given wcs.</span>
<span class="sd">    If not WCS is provided, just opens a subplot in that figure.</span>

<span class="sd">    Args:</span>
<span class="sd">        nfig (int): number of the Figure to consider</span>
<span class="sd">        mywcs (astropy.wcs.WCS): Input WCS to open a new figure</span>

<span class="sd">    Returns:</span>
<span class="sd">        fig, subplot: Figure itself with the subplots with the wcs projection</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1"># get the figure</span>
    <span class="n">fig</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">(</span><span class="n">nfig</span><span class="p">)</span>
    <span class="c1"># Clean the figure</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">clf</span><span class="p">()</span>
    <span class="c1"># Adding axes with WCS</span>
    <span class="k">if</span> <span class="n">mywcs</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">return</span> <span class="n">fig</span><span class="p">,</span> <span class="n">fig</span><span class="o">.</span><span class="n">add_subplot</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="n">projection</span><span class="o">=</span><span class="n">mywcs</span><span class="p">)</span></div>


<div class="viewcode-block" id="chunk_stats"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.chunk_stats">[docs]</a><span class="k">def</span> <span class="nf">chunk_stats</span><span class="p">(</span><span class="n">list_data</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">15</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Cut the datasets in 2d chunks and take the median</span>
<span class="sd">    Return the set of medians for all chunks.</span>

<span class="sd">    Args:</span>
<span class="sd">        list_data (list of np.arrays): List of arrays with the same sizes/shapes</span>
<span class="sd">        chunk_size (int): number of pixel (one D of a 2D chunk)</span>
<span class="sd">           of the chunk to consider</span>

<span class="sd">    Returns:</span>
<span class="sd">        median, standard: 2 arrays of the medians and</span>
<span class="sd">            standard deviations for the given datasets analysed in chunks.</span>

<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">ndatasets</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">list_data</span><span class="p">)</span>

    <span class="n">nchunk_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="n">nchunk_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">list_data</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="n">chunk_size</span> <span class="o">-</span> <span class="mi">1</span><span class="p">)</span>
    <span class="c1"># Check that all datasets have the same size</span>
    <span class="n">med_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ndatasets</span><span class="p">,</span> <span class="n">nchunk_x</span> <span class="o">*</span> <span class="n">nchunk_y</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">std_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">med_data</span><span class="p">)</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">d</span><span class="o">.</span><span class="n">size</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">list_data</span><span class="p">]):</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Datasets are not of the same &quot;</span>
                          <span class="s2">&quot;size in median_compare&quot;</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchunk_x</span><span class="p">):</span>
            <span class="k">for</span> <span class="n">j</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">nchunk_y</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">k</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ndatasets</span><span class="p">):</span>
                    <span class="c1"># Taking the median</span>
                    <span class="n">med_data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">nchunk_y</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span>
                            <span class="n">list_data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">,</span> 
                            <span class="n">j</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">])</span>
                    <span class="n">std_data</span><span class="p">[</span><span class="n">k</span><span class="p">,</span> <span class="n">i</span><span class="o">*</span><span class="n">nchunk_y</span> <span class="o">+</span> <span class="n">j</span><span class="p">]</span> <span class="o">=</span> <span class="n">mad_std</span><span class="p">(</span>
                            <span class="n">list_data</span><span class="p">[</span><span class="n">k</span><span class="p">][</span><span class="n">i</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">:(</span><span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">,</span> 
                            <span class="n">j</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">:(</span><span class="n">j</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_size</span><span class="p">],</span> <span class="n">ignore_nan</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="c1"># Cleaning in case of Nan</span>
    <span class="n">med_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">med_data</span><span class="p">)</span>
    <span class="n">std_data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">std_data</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">med_data</span><span class="p">,</span> <span class="n">std_data</span></div>


<div class="viewcode-block" id="my_linear_model"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.my_linear_model">[docs]</a><span class="k">def</span> <span class="nf">my_linear_model</span><span class="p">(</span><span class="n">B</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Linear function for the regression.</span>
<span class="sd">     </span>
<span class="sd">    Args</span>
<span class="sd">        B (1D array of 2): Input 1D polynomial parameters (0=constant, 1=slope)</span>
<span class="sd">        x (array): Array which will be multiplied by the polynomial</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">        An array = B[1] * (x + B[0])</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">return</span> <span class="n">B</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">*</span> <span class="p">(</span><span class="n">x</span> <span class="o">+</span> <span class="n">B</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span></div>


<div class="viewcode-block" id="get_image_norm_poly"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.get_image_norm_poly">[docs]</a><span class="k">def</span> <span class="nf">get_image_norm_poly</span><span class="p">(</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> 
        <span class="n">threshold1</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">threshold2</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Find the normalisation factor between two datasets.</span>

<span class="sd">    Including the background and slope. This uses the function</span>
<span class="sd">    regress_odr which is included in align_pipe.py and itself</span>
<span class="sd">    makes use of ODR in scipy.odr.ODR.</span>
<span class="sd">     </span>
<span class="sd">    Args</span>
<span class="sd">        data1 (array):</span>
<span class="sd">        data2 (array): 2 arrays (2D) of identical shapes</span>
<span class="sd">        chunk_size (int): Size of the chunk to bin the images</span>
<span class="sd">        threshold1 (float):</span>
<span class="sd">        threshold2 (float): 2 floats defining the lower threshold for filtering</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">        result: python structure</span>
<span class="sd">                Result of the regression (ODR)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># proceeds by splitting the data arrays in chunks of chunk_size</span>
    <span class="n">med</span><span class="p">,</span> <span class="n">std</span> <span class="o">=</span> <span class="n">chunk_stats</span><span class="p">([</span><span class="n">data1</span><span class="p">,</span> <span class="n">data2</span><span class="p">],</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

    <span class="c1"># Selecting where data is supposed to be good</span>
    <span class="n">pos</span> <span class="o">=</span> <span class="p">(</span><span class="n">med</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">std</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">med</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">threshold2</span><span class="p">)</span>
    <span class="c1"># Guess the slope from this selection</span>
    <span class="n">guess_slope</span> <span class="o">=</span> <span class="mf">1.0</span>
<span class="c1">#    guess_slope = np.abs(np.nanmedian(med[1][pos] / med[0][pos]))</span>

    <span class="c1"># Doing the regression itself</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">regress_odr</span><span class="p">(</span><span class="n">x</span><span class="o">=</span><span class="n">med</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span> <span class="n">y</span><span class="o">=</span><span class="n">med</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span> <span class="n">sx</span><span class="o">=</span><span class="n">std</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span>
                         <span class="n">sy</span><span class="o">=</span><span class="n">std</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">pos</span><span class="p">],</span> <span class="n">beta0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="n">guess_slope</span><span class="p">])</span>
    <span class="n">result</span><span class="o">.</span><span class="n">med</span> <span class="o">=</span> <span class="n">med</span>
    <span class="n">result</span><span class="o">.</span><span class="n">std</span> <span class="o">=</span> <span class="n">std</span>
    <span class="n">result</span><span class="o">.</span><span class="n">selection</span> <span class="o">=</span> <span class="n">pos</span>
    <span class="k">return</span> <span class="n">result</span></div>


<div class="viewcode-block" id="regress_odr"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.regress_odr">[docs]</a><span class="k">def</span> <span class="nf">regress_odr</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="n">sx</span><span class="p">,</span> <span class="n">sy</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">1.</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Return an ODR linear regression using scipy.odr.ODR</span>

<span class="sd">    Args:</span>
<span class="sd">        x (np.array): Input nD arrays with signal</span>
<span class="sd">        y (np.array):</span>
<span class="sd">        sx (np.array): Input nD arrays (as x,y) with standard deviations</span>
<span class="sd">        sy (np.array):</span>
<span class="sd">        beta0 (list of 2 floats): Initial guess for the constant and slope</span>

<span class="sd">    Returns:</span>
<span class="sd">        result: result of the ODR analysis</span>

<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">linear</span> <span class="o">=</span> <span class="n">Model</span><span class="p">(</span><span class="n">my_linear_model</span><span class="p">)</span>
    <span class="n">mydata</span> <span class="o">=</span> <span class="n">RealData</span><span class="p">(</span><span class="n">x</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">y</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">sx</span><span class="o">=</span><span class="n">sx</span><span class="o">.</span><span class="n">ravel</span><span class="p">(),</span> <span class="n">sy</span><span class="o">=</span><span class="n">sy</span><span class="o">.</span><span class="n">ravel</span><span class="p">())</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">ODR</span><span class="p">(</span><span class="n">mydata</span><span class="p">,</span> <span class="n">linear</span><span class="p">,</span> <span class="n">beta0</span><span class="o">=</span><span class="n">beta0</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="o">.</span><span class="n">run</span><span class="p">()</span></div>

<div class="viewcode-block" id="get_conversion_factor"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.get_conversion_factor">[docs]</a><span class="k">def</span> <span class="nf">get_conversion_factor</span><span class="p">(</span><span class="n">input_unit</span><span class="p">,</span> <span class="n">output_unit</span><span class="p">,</span> <span class="n">filter_name</span><span class="o">=</span><span class="s2">&quot;WFI&quot;</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot; Conversion of units from an input one</span>
<span class="sd">    to an output one</span>
<span class="sd">     </span>
<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    input_unit: astropy unit</span>
<span class="sd">        Input astropy unit to analyse</span>
<span class="sd">    output_unit: astropy unit</span>
<span class="sd">        Astropy unit to compare to input unit.</span>
<span class="sd">    equivalencies: astropy equivalency</span>
<span class="sd">        Used in case there is an existing equivalency</span>
<span class="sd">        to help the conversion</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    conversion: astropy unit conversion</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">filter_name</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">dict_equivalencies</span><span class="p">:</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Didn&#39;t find conversion for this filter. &quot;</span>
                            <span class="s2">&quot;Using 1.0 as a conversion factor&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="mf">1.0</span>

    <span class="n">equivalencies</span> <span class="o">=</span> <span class="n">dict_equivalencies</span><span class="p">[</span><span class="n">filter_name</span><span class="p">]</span>
    <span class="c1"># First testing if the quantities are Quantity</span>
    <span class="c1"># If not, transform them </span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_unit</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">quantity</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">input_unit</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Unit</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CompositeUnit</span><span class="p">)):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Input provided unit could not be converted&quot;</span><span class="p">)</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Using 1.0 as a conversion factor&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="n">input_unit</span> <span class="o">=</span> <span class="n">input_unit</span> <span class="o">*</span> <span class="mf">1.0</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_unit</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">quantity</span><span class="o">.</span><span class="n">Quantity</span><span class="p">):</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">output_unit</span><span class="p">,</span> <span class="p">(</span><span class="n">u</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">Unit</span><span class="p">,</span> <span class="n">u</span><span class="o">.</span><span class="n">core</span><span class="o">.</span><span class="n">CompositeUnit</span><span class="p">)):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Output provided unit could not be converted&quot;</span><span class="p">)</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Using 1.0 as a conversion factor&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">output_unit</span> <span class="o">=</span> <span class="n">output_unit</span> <span class="o">*</span> <span class="mf">1.0</span>

    <span class="k">if</span> <span class="ow">not</span> <span class="n">input_unit</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">is_equivalent</span><span class="p">(</span><span class="n">output_unit</span><span class="p">):</span>
        <span class="c1"># if not equivalent we try a spectral density equivalence</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">input_unit</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">is_equivalent</span><span class="p">(</span><span class="n">output_unit</span><span class="p">,</span> 
                                             <span class="n">equivalencies</span><span class="o">=</span><span class="n">equivalencies</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Provided units for reference &quot;</span>
                                <span class="s2">&quot;and MUSE images are not equivalent&quot;</span><span class="p">)</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;A conversion factor of 1.0 will thus be used&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mf">1.0</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="k">return</span> <span class="n">input_unit</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span>
                    <span class="n">output_unit</span><span class="p">,</span> <span class="n">equivalencies</span><span class="o">=</span><span class="n">equivalencies</span><span class="p">)</span> <span class="o">*</span> <span class="n">input_unit</span><span class="o">.</span><span class="n">value</span> 
    <span class="k">else</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">input_unit</span><span class="o">.</span><span class="n">unit</span><span class="o">.</span><span class="n">to</span><span class="p">(</span><span class="n">output_unit</span><span class="p">)</span> <span class="o">*</span> <span class="n">input_unit</span><span class="o">.</span><span class="n">value</span></div>

<div class="viewcode-block" id="arcsec_to_pixel"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.arcsec_to_pixel">[docs]</a><span class="k">def</span> <span class="nf">arcsec_to_pixel</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">xy_arcsec</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Transform from arcsec to pixel for the muse image</span>
<span class="sd">    using the hdu to extract the WCS, hence the scaling.</span>
<span class="sd">     </span>
<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    hdu: astropy hdu (fits)</span>
<span class="sd">        Input hdu which includes a WCS</span>
<span class="sd">    xy_arcsec: list of 2 floats ([0,0])</span>
<span class="sd">        Coordinates to transform from arcsec to pixel.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xpix, ypix: 2 floats</span>
<span class="sd">        Pixel coordinates</span>

<span class="sd">    See also: pixel_to_arcsec (align_pipe.py)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Matrix</span>
    <span class="n">input_wcs</span> <span class="o">=</span> <span class="n">awcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
    <span class="n">scale_matrix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">input_wcs</span><span class="o">.</span><span class="n">pixel_scale_matrix</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">)</span>

    <span class="c1"># Transformation in Pixels</span>
    <span class="n">dels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xy_arcsec</span><span class="p">)</span>
    <span class="n">xpix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dels</span> <span class="o">*</span> <span class="n">scale_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:])</span>
    <span class="n">ypix</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dels</span> <span class="o">*</span> <span class="n">scale_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:])</span>
    <span class="k">return</span> <span class="n">xpix</span><span class="p">,</span> <span class="n">ypix</span></div>

<div class="viewcode-block" id="pixel_to_arcsec"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.pixel_to_arcsec">[docs]</a><span class="k">def</span> <span class="nf">pixel_to_arcsec</span><span class="p">(</span><span class="n">hdu</span><span class="p">,</span> <span class="n">xy_pixel</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span><span class="mf">0.</span><span class="p">]):</span>
    <span class="sd">&quot;&quot;&quot;Transform from arcsec to pixel for the muse image</span>
<span class="sd">    using the hdu to extract the WCS, hence the scaling.</span>
<span class="sd">     </span>
<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    hdu: astropy hdu (fits)</span>
<span class="sd">        Input hdu which includes a WCS</span>
<span class="sd">    xy_pixel: list of 2 floats ([0,0])</span>
<span class="sd">        Coordinates to transform from pixel to arcsec</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    xarc, yarc: 2 floats</span>
<span class="sd">        Arcseconds coordinates</span>

<span class="sd">    See also: arcsec_to_pixel (align_pipe.py)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Matrix</span>
    <span class="n">input_wcs</span> <span class="o">=</span> <span class="n">awcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

    <span class="c1"># Transformation in arcsecond</span>
    <span class="n">dels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">xy_pixel</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
    <span class="n">xarc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dels</span> <span class="o">*</span> <span class="n">input_wcs</span><span class="o">.</span><span class="n">pixel_scale_matrix</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">)</span>
    <span class="n">yarc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">dels</span> <span class="o">*</span> <span class="n">input_wcs</span><span class="o">.</span><span class="n">pixel_scale_matrix</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">xarc</span><span class="p">,</span> <span class="n">yarc</span></div>


<div class="viewcode-block" id="crop_data"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.crop_data">[docs]</a><span class="k">def</span> <span class="nf">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Crop a 2D data and return it cropped after a border</span>
<span class="sd">    has been removed (number of pixels) from each edge</span>
<span class="sd">    (borderx2 pixels are removed from each dimension)</span>
<span class="sd">    </span>
<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2d array</span>
<span class="sd">        Array which has the signal to be cropped</span>
<span class="sd">    border: int</span>
<span class="sd">        Number of pixels to be cropped at each edge</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cdata: 2d array</span>
<span class="sd">        Cropped data array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">if</span> <span class="n">border</span> <span class="o">&lt;=</span> <span class="mi">0</span> <span class="p">:</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">if</span> <span class="n">data</span><span class="o">.</span><span class="n">ndim</span> <span class="o">!=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Input data to crop is not 2, &quot;</span>
                      <span class="s2">&quot;returning the original data&quot;</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">data</span>

    <span class="k">if</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">border</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">border</span><span class="p">):</span>
        <span class="k">return</span> <span class="n">data</span><span class="p">[</span><span class="n">border</span><span class="p">:</span><span class="o">-</span><span class="n">border</span><span class="p">,</span> <span class="n">border</span><span class="p">:</span><span class="o">-</span><span class="n">border</span><span class="p">]</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Data is not being cropped, as shape is </span><span class="si">{0}</span><span class="s2"> &quot;</span>
             <span class="s2">&quot; while border is </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">border</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">data</span></div>


<div class="viewcode-block" id="filtermed_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.filtermed_image">[docs]</a><span class="k">def</span> <span class="nf">filtermed_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">filter_size</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process image by removing the borders</span>
<span class="sd">    and filtering it via a median filter</span>
<span class="sd">     </span>
<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2d array</span>
<span class="sd">        Array to be processed</span>
<span class="sd">    border: int</span>
<span class="sd">        Number of pixels to remove at each edge</span>
<span class="sd">    filter_size: float</span>
<span class="sd">        Size of the filtering (median)</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    cdata: 2d array</span>
<span class="sd">        Processed array</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Omit the border pixels</span>
    <span class="k">if</span> <span class="n">border</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">)</span>
    <span class="n">meddata</span> <span class="o">=</span> <span class="n">nd</span><span class="o">.</span><span class="n">filters</span><span class="o">.</span><span class="n">median_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">filter_size</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">meddata</span></div>


<div class="viewcode-block" id="prepare_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.prepare_image">[docs]</a><span class="k">def</span> <span class="nf">prepare_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">dynamic_range</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> 
                  <span class="n">median_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">minflux</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Process image by squeezing the range, removing </span>
<span class="sd">    the borders and filtering it. The image is first filtered, </span>
<span class="sd">    then it is cropped. All values below a given minimum are </span>
<span class="sd">    set to 0 and all Nan set to 0 or infinity accordingly.</span>
<span class="sd">     </span>
<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    data: 2d array</span>
<span class="sd">        Input array to process</span>
<span class="sd">    dynamic_range: float [10]</span>
<span class="sd">        Dynamic range used to squash the bright pixels down</span>
<span class="sd">    median_window: int [10]</span>
<span class="sd">        Size of the window used for the median filtering.</span>
<span class="sd">    minflux: float [0]</span>
<span class="sd">        Value of the minimum flux allowed.</span>
<span class="sd">    </span>
<span class="sd">    Returns</span>
<span class="sd">    -------</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># Squish bright pixels down</span>
    <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan</span><span class="p">(</span><span class="n">data</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmedian</span><span class="p">(</span><span class="n">data</span><span class="p">)</span> <span class="o">/</span> <span class="n">dynamic_range</span><span class="p">)</span>

    <span class="c1"># Omit the border pixels</span>
    <span class="n">data</span> <span class="o">-=</span> <span class="n">filtermed_image</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">median_window</span><span class="p">)</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>

    <span class="c1"># Removing the zeros</span>
    <span class="k">with</span> <span class="n">np</span><span class="o">.</span><span class="n">errstate</span><span class="p">(</span><span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">):</span>
        <span class="n">cdata</span><span class="p">[</span><span class="n">cdata</span> <span class="o">&lt;</span> <span class="n">minflux</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.</span>

    <span class="c1"># Clean up the NaNs</span>
    <span class="n">cdata</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">cdata</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cdata</span></div>


<div class="viewcode-block" id="rotate_pixtables"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.rotate_pixtables">[docs]</a><span class="k">def</span> <span class="nf">rotate_pixtables</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">list_ifu</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                     <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Will update the derotator angle in each of the 24 pixtables</span>
<span class="sd">    Using a loop on rotate_pixtable</span>

<span class="sd">    Will thus update the HIERARCH ESO INS DROT POSANG keyword.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    folder: str</span>
<span class="sd">        name of the folder where the PIXTABLE are</span>
<span class="sd">    name_suffix: str</span>
<span class="sd">        name of the suffix to be used on top of PIXTABLE_OBJECT</span>
<span class="sd">    list_ifu: list[int]</span>
<span class="sd">        List of Pixtable numbers. If None, will do all 24</span>
<span class="sd">    angle: float</span>
<span class="sd">        Angle to rotate (in degrees)</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="k">if</span> <span class="n">list_ifu</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">list_ifu</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">24</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="k">for</span> <span class="n">nifu</span> <span class="ow">in</span> <span class="n">list_ifu</span><span class="p">:</span>
        <span class="n">rotate_pixtable</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="n">folder</span><span class="p">,</span> <span class="n">name_suffix</span><span class="o">=</span><span class="n">name_suffix</span><span class="p">,</span> <span class="n">nifu</span><span class="o">=</span><span class="n">nifu</span><span class="p">,</span>
                        <span class="n">angle</span><span class="o">=</span><span class="n">angle</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>


<div class="viewcode-block" id="rotate_pixtable"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.rotate_pixtable">[docs]</a><span class="k">def</span> <span class="nf">rotate_pixtable</span><span class="p">(</span><span class="n">folder</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">name_suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">nifu</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">angle</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Rotate a single IFU PIXTABLE_OBJECT</span>
<span class="sd">    Will thus update the HIERARCH ESO INS DROT POSANG keyword.</span>

<span class="sd">    Input</span>
<span class="sd">    -----</span>
<span class="sd">    folder: str</span>
<span class="sd">        name of the folder where the PIXTABLE are</span>
<span class="sd">    name_suffix: str</span>
<span class="sd">        name of the suffix to be used on top of PIXTABLE_OBJECT</span>
<span class="sd">    nifu: int</span>
<span class="sd">        Pixtable number. Default is 1</span>
<span class="sd">    angle: float</span>
<span class="sd">        Angle to rotate (in degrees)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">angle_keyword</span> <span class="o">=</span> <span class="s2">&quot;HIERARCH ESO INS DROT POSANG&quot;</span>
    <span class="n">angle_orig_keyword</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> ORIG&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">angle_keyword</span><span class="p">)</span>

    <span class="n">pixtable_basename</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;pixtable_basename&quot;</span><span class="p">,</span>
                                   <span class="n">dict_listObject</span><span class="p">[</span><span class="s1">&#39;OBJECT&#39;</span><span class="p">])</span>
    <span class="n">prefix</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;prefix&quot;</span><span class="p">,</span> <span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="n">name_pixtable</span> <span class="o">=</span> <span class="s2">&quot;</span><span class="si">{0}{1}</span><span class="s2">_</span><span class="si">{2}</span><span class="s2">-</span><span class="si">{3:02d}</span><span class="s2">.fits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">prefix</span><span class="p">,</span> <span class="n">pixtable_basename</span><span class="p">,</span>
                                                     <span class="n">name_suffix</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">nifu</span><span class="p">))</span>
    <span class="n">fullname_pixtable</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="n">folder</span><span class="p">,</span> <span class="n">name_pixtable</span><span class="p">)</span>
    <span class="n">fakemode</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;fakemode&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>

    <span class="c1"># Check if table is there</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">fullname_pixtable</span><span class="p">):</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Input Pixtable </span><span class="si">{0}</span><span class="s2"> does not exist - Aborting&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
            <span class="n">fullname_pixtable</span><span class="p">))</span>
        <span class="k">return</span>

    <span class="c1"># Continue with updating the table</span>
    <span class="n">mypix</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">fullname_pixtable</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;update&#39;</span><span class="p">)</span>
    <span class="n">hd</span> <span class="o">=</span> <span class="n">mypix</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">fakemode</span> <span class="ow">and</span> <span class="n">angle</span> <span class="o">!=</span> <span class="mf">0.0</span><span class="p">:</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">angle_orig_keyword</span> <span class="ow">in</span> <span class="n">hd</span><span class="p">:</span>
            <span class="n">hd</span><span class="p">[</span><span class="n">angle_orig_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="n">angle_keyword</span><span class="p">]</span>
        <span class="n">hd</span><span class="p">[</span><span class="n">angle_keyword</span><span class="p">]</span> <span class="o">=</span> <span class="n">hd</span><span class="p">[</span><span class="n">angle_orig_keyword</span><span class="p">]</span> <span class="o">+</span> <span class="n">angle</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Updating INS DROT POSANG for </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_pixtable</span><span class="p">))</span>
        <span class="n">mypix</span><span class="o">.</span><span class="n">flush</span><span class="p">()</span>

    <span class="c1"># Reading the result and printing</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;=== </span><span class="si">{}</span><span class="s2"> === &quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_pixtable</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">angle_orig_keyword</span> <span class="ow">in</span> <span class="n">hd</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Present Angle [No Change] (deg): </span><span class="si">{}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">hd</span><span class="p">[</span><span class="n">angle_keyword</span><span class="p">]))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Orig / New / Rotation Angle (deg): </span><span class="si">{0:8.4f}</span><span class="s2"> / </span><span class="si">{1:8.4f}</span><span class="s2"> / </span><span class="si">{2:8.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                         <span class="n">hd</span><span class="p">[</span><span class="n">angle_orig_keyword</span><span class="p">],</span>
                         <span class="n">hd</span><span class="p">[</span><span class="n">angle_keyword</span><span class="p">],</span>
                         <span class="n">np</span><span class="o">.</span><span class="n">float</span><span class="p">(</span><span class="n">hd</span><span class="p">[</span><span class="n">angle_keyword</span><span class="p">])</span> <span class="o">-</span> <span class="n">hd</span><span class="p">[</span><span class="n">angle_orig_keyword</span><span class="p">]))</span></div>

<span class="c1">#################################################################</span>
<span class="c1"># ================== END Useful functions ===================== #</span>
<span class="c1">#################################################################</span>

<span class="c1"># Main alignment Class</span>
<div class="viewcode-block" id="AlignMusePointing"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing">[docs]</a><span class="k">class</span> <span class="nc">AlignMusePointing</span><span class="p">(</span><span class="nb">object</span><span class="p">):</span>
    <span class="sd">&quot;&quot;&quot;Class to align MUSE images onto a reference image.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_reference</span><span class="p">,</span>
                 <span class="n">folder_reference</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                 <span class="n">folder_muse_images</span><span class="o">=</span><span class="s2">&quot;.&quot;</span><span class="p">,</span>
                 <span class="n">name_muse_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">sel_indices_images</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
                 <span class="n">median_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">subim_window</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">dynamic_range</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span>
                 <span class="n">border</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">hdu_ext</span><span class="o">=</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">],</span>
                 <span class="n">chunk_size</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span>
                 <span class="n">threshold_muse</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                 <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise the AlignMuseImages class.</span>
<span class="sd">        </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        name_reference: str</span>
<span class="sd">            Name of the reference image (fits file)</span>
<span class="sd">        folder_reference: str [&quot;&quot;]</span>
<span class="sd">            Folder name of the reference image</span>
<span class="sd">        folder_muse_images: str [&quot;&quot;]</span>
<span class="sd">            Folder name for the input images to compare</span>
<span class="sd">        name_muse_images: str or list</span>
<span class="sd">            List of names for the MUSE images (or str if only 1 image)</span>
<span class="sd">        suffix_muse_images: str</span>
<span class="sd">            Suffix to be used for muse image names </span>
<span class="sd">            if only a subset should be selected.</span>
<span class="sd">        filter_name: str</span>
<span class="sd">            Name of filter to consider when filtering the muse image names</span>
<span class="sd">        firstguess: str</span>
<span class="sd">            If &quot;crosscorr&quot;, will use cross-correlation to guess</span>
<span class="sd">            the alignment offsets.</span>
<span class="sd">            If &quot;fits&quot;, will use input fits OFFSET table to start with</span>
<span class="sd">        name_offset_table: str</span>
<span class="sd">            Name of the fits OFFSET table. Only used as input</span>
<span class="sd">            as guess if &quot;firstguess&quot; is set to &quot;fits&quot;. This name will be the</span>
<span class="sd">            default name when saving the offsets in an OFFSET fits table.</span>
<span class="sd">        sel_indices_images: list [None]</span>
<span class="sd">            List of images to select from the given set</span>
<span class="sd">        median_window: int [10]</span>
<span class="sd">            Size of window used in median filter to extract features in</span>
<span class="sd">            cross-correlation.  Should be an odd integer</span>
<span class="sd">        subim_window: int [10]</span>
<span class="sd">            Size of window for fitting peak of cross-correlation function</span>
<span class="sd">        dynamic_range: float [10]</span>
<span class="sd">            Apply an arctan transform to data to suppress values more than</span>
<span class="sd">            DynamicRange times the median of the image</span>
<span class="sd">        border: int [10]</span>
<span class="sd">            Ignore pixels this close to the border in the cross correlation</span>
<span class="sd">        hdu_ext: list of 2 floats [0,1]</span>
<span class="sd">            Number of the extension for the input reference image </span>
<span class="sd">            and images to align, respectively. This is used to know</span>
<span class="sd">            where the data lies in the fits file.</span>
<span class="sd">        chunk_size: int [15]</span>
<span class="sd">            Size in pixels of the chunk used to bin and compute the </span>
<span class="sd">            normalisation factors</span>
<span class="sd">        threshold_muse: float [0]</span>
<span class="sd">            Minimum threshold value to consider for the input </span>
<span class="sd">            images to align</span>

<span class="sd">        Other keywords</span>
<span class="sd">        --------------</span>
<span class="sd">        verbose: bool [True]</span>
<span class="sd">            If True, spits out more verbose output</span>
<span class="sd">        plot: bool [True]</span>
<span class="sd">            If True, will provide plots</span>
<span class="sd">        debug: bool [False]</span>
<span class="sd">            If True, will provide some info to debug</span>
<span class="sd">            which will be stored in the python class</span>
<span class="sd">            as new attributes. Look for self._temp...</span>
<span class="sd">        use_polynorm: bool [True]</span>
<span class="sd">            Save the polynomial fitted slope and use as normalisation</span>
<span class="sd">            factors</span>
<span class="sd">        convert_units: bool [True]</span>
<span class="sd">            Use the given units to convert fluxes</span>
<span class="sd">        ref_unit: astropy unit</span>
<span class="sd">            Reference image unit</span>
<span class="sd">        muse_unit: astropy unit</span>
<span class="sd">            Input MUSE flux unit</span>
<span class="sd">        minflux_crosscorr: float [0]</span>
<span class="sd">            Minimum flux to consider when doing the cross-correlation.</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="c1"># Some input variables for the cross-correlation</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;verbose&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">plot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plot&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">border</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">border</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">int</span><span class="p">(</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">subim_window</span> <span class="o">=</span> <span class="n">subim_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">median_window</span> <span class="o">=</span> <span class="n">median_window</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_range</span> <span class="o">=</span> <span class="n">dynamic_range</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_reference</span> <span class="o">=</span> <span class="n">name_reference</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_reference</span> <span class="o">=</span> <span class="n">folder_reference</span>

        <span class="c1"># Debug option</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;debug&quot;</span><span class="p">,</span> <span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;In DEBUG Mode [more printing]&quot;</span><span class="p">)</span>

        <span class="c1"># Check if folder reference exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_reference</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Provided folder_reference is &quot;</span>
                        <span class="s2">&quot;not an existing folder&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">name_muse_images</span> <span class="o">=</span> <span class="n">name_muse_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">sel_indices_images</span> <span class="o">=</span> <span class="n">sel_indices_images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_muse_images</span> <span class="o">=</span> <span class="n">folder_muse_images</span>
        <span class="c1"># Check if folder muse images exists</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isdir</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_muse_images</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Provided folder_muse_images is &quot;</span>
                        <span class="s2">&quot;not an existing folder&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Creating the Header-Align folder</span>
        <span class="n">header_folder_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;header_folder_name&quot;</span><span class="p">,</span> <span class="s2">&quot;AlignHeaders&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">header_folder_name</span> <span class="o">=</span> <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_muse_images</span><span class="p">,</span> <span class="n">header_folder_name</span><span class="p">)</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">safely_create_folder</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_folder_name</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">)</span>

        <span class="c1"># Getting the names</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_musehdr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name_musehdr&quot;</span><span class="p">,</span> <span class="s2">&quot;muse&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_offmusehdr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name_offmusehdr&quot;</span><span class="p">,</span> <span class="s2">&quot;offsetmuse&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_refhdr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name_refhdr&quot;</span><span class="p">,</span> <span class="s2">&quot;reference.hdr&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix_images</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;suffix_muse_images&quot;</span><span class="p">,</span> <span class="s2">&quot;IMAGE_FOV&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;filter_name&quot;</span><span class="p">,</span> <span class="s2">&quot;WFI_BB&quot;</span><span class="p">)</span>

        <span class="c1"># Use polynorm or not</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_polynorm</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_polynorm&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>

        <span class="c1"># Use rotation angles from the offset table if they exist</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">use_rotangles</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;use_rotangles&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_rotangles</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;By default, rotation angles given in initial &quot;</span>
                                <span class="s2">&quot;offset table will be used if they exist. If &quot;</span>
                                <span class="s2">&quot;not, all initial rotation angles will be set to 0.&quot;</span><span class="p">)</span>

        <span class="c1"># Getting the unit conversions</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;convert_units&quot;</span><span class="p">,</span> <span class="kc">True</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">convert_units</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ref_unit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;ref_unit&quot;</span><span class="p">,</span> <span class="n">default_reference_unit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">muse_unit</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;muse_unit&quot;</span><span class="p">,</span> <span class="n">default_muse_unit</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversion_factor</span> <span class="o">=</span> <span class="n">get_conversion_factor</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ref_unit</span><span class="p">,</span> 
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">muse_unit</span><span class="p">,</span>
                                                           <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">)</span>
        <span class="k">else</span> <span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">conversion_factor</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="c1"># Initialise the parameters for the first guess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstguess</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;firstguess&quot;</span><span class="p">,</span> <span class="s2">&quot;crosscorr&quot;</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_offset_table</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_offset_table&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">folder_output_table</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;folder_output_table&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_offset_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_offset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_muse_images</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_output_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_output_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">folder_offset_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_offset_table</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;name_offset_table&quot;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">minflux_crosscorr</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;minflux_crosscorr&quot;</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>

        <span class="c1"># Get the MUSE images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_get_list_muse_images</span><span class="p">()</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2"> MUSE images detected as input&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">))</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;No MUSE images detected. Aborted&quot;</span><span class="p">)</span>
            <span class="k">return</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_offmuse_hdu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_proj_refhdu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_proj_refhdu</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>

        <span class="c1"># Initialise the needed arrays for the offsets</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_off_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_off_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span><span class="p">)</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">extra_rotangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

        <span class="c1"># RESET! all parameters</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_reset_init_guess_values</span><span class="p">()</span>

        <span class="c1"># Cross normalisation for the images</span>
        <span class="c1"># This contains the parameters of the linear fit</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="c1"># Normalisation factor to be saved or used</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_background</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">threshold_muse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span><span class="p">)</span> <span class="o">+</span> <span class="n">threshold_muse</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_muse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_reference</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span><span class="p">)</span>
        <span class="c1"># Default lists for date, mjd, tpls of the MUSE images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_dateobs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_mjdobs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_tplstart</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_iexpo</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_pointing</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>

        <span class="c1"># Which extension to be used for the ref and muse images</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">hdu_ext</span> <span class="o">=</span> <span class="n">hdu_ext</span>

        <span class="c1"># Open the Ref and MUSE image</span>
        <span class="n">status_open</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_hdu</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_open</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Problem in opening frames, please check your input&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Initialise the offsets using the cross-correlation or FITS table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_guess_offset</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">firstguess</span><span class="p">)</span>

        <span class="c1"># Now doing the shifts and projections with the guess/input values</span>
        <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">nima</span><span class="p">)</span>

<div class="viewcode-block" id="AlignMusePointing.show_norm_factors"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.show_norm_factors">[docs]</a>    <span class="k">def</span> <span class="nf">show_norm_factors</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print some information about the normalisation factors.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Normalisation factors&quot;</span><span class="p">)</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Image # : InitFluxScale     SlopeFit       NormFactor       Background&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Image </span><span class="si">{0:03d}</span><span class="s2">:  </span><span class="si">{1:10.6e}</span><span class="s2">   </span><span class="si">{2:10.6e}</span><span class="s2">     </span><span class="si">{3:10.6e}</span><span class="s2">     </span><span class="si">{4:10.6e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nima</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_flux_scale</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ima_background</span><span class="p">[</span><span class="n">nima</span><span class="p">]))</span></div>

<div class="viewcode-block" id="AlignMusePointing.show_linearfit_values"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.show_linearfit_values">[docs]</a>    <span class="k">def</span> <span class="nf">show_linearfit_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print some information about the linearly fitted parameters</span>
<span class="sd">        pertaining to the normalisation.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Normalisation factors&quot;</span><span class="p">)</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Image # : BackGround        Slope&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Image </span><span class="si">{0:03d}</span><span class="s2">:  </span><span class="si">{1:10.6e}</span><span class="s2">   </span><span class="si">{2:10.6e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">nima</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> 
                    <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span></div>

<div class="viewcode-block" id="AlignMusePointing.init_guess_offset"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.init_guess_offset">[docs]</a>    <span class="k">def</span> <span class="nf">init_guess_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">firstguess</span><span class="o">=</span><span class="s2">&quot;crosscorr&quot;</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Initialise first guess, either from cross-correlation (default)</span>
<span class="sd">        or from an Offset FITS Table</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        firstguess: str</span>
<span class="sd">            If &quot;crosscorr&quot; uses cross-correlation to get the first guess</span>
<span class="sd">            of the offsets. If &quot;fits&quot; uses the input fits table.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Implement the guess</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">firstguess</span> <span class="o">=</span> <span class="n">firstguess</span>
        <span class="k">if</span> <span class="n">firstguess</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;No initial guess shift: all set to 0&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_off_arcsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_arcsec</span> <span class="o">*</span> <span class="mf">0.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_off_pixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span> <span class="o">*</span> <span class="mf">0.0</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="n">firstguess</span> <span class="ow">not</span> <span class="ow">in</span> <span class="p">[</span><span class="s2">&quot;crosscorr&quot;</span><span class="p">,</span> <span class="s2">&quot;fits&quot;</span><span class="p">]:</span>
            <span class="n">firstguess</span> <span class="o">=</span> <span class="s2">&quot;crosscorr&quot;</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Keyword &#39;firstguess&#39; not recognised&quot;</span><span class="p">)</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Using Cross-Correlation as &quot;</span>
                                <span class="s2">&quot;a first guess of the alignment&quot;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">firstguess</span> <span class="o">==</span> <span class="s2">&quot;crosscorr&quot;</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Using cross-correlation as the initial guess&quot;</span><span class="p">)</span>
            <span class="c1"># find the cross correlation peaks for each image</span>
            <span class="c1"># This is using zero offset and zero rotation</span>
            <span class="c1"># as all parameters have been reset above</span>
            <span class="c1"># New values will be taken out from the cross-correlation or fits table</span>
            <span class="c1"># just below with the init_guess_offset</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">find_ncross_peak</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">init_off_arcsec</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_arcsec</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">init_off_pixel</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span> <span class="o">*</span> <span class="mf">1.0</span>
        <span class="k">elif</span> <span class="n">firstguess</span> <span class="o">==</span> <span class="s2">&quot;fits&quot;</span><span class="p">:</span>
            <span class="n">exist_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_offset_table</span><span class="p">(</span>
                    <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_offset_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_offset_table</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">exist_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">True</span> <span class="p">:</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Fits initialisation table not found, &quot;</span>
                                    <span class="s2">&quot;setting init value to 0&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_init_guess_values</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Using input FITS table as initial guess: </span><span class="si">{0}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                                 <span class="bp">self</span><span class="o">.</span><span class="n">name_offset_table</span><span class="p">))</span>
            <span class="c1"># First get the right indices for the table by comparing MJD_OBS</span>
            <span class="k">if</span> <span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Input table does not &quot;</span>
                                    <span class="s2">&quot;contain MJD_OBS column&quot;</span><span class="p">)</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">_reset_init_guess_values</span><span class="p">()</span>
                <span class="k">return</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">table_mjdobs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="p">[</span><span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span>
            <span class="c1"># Now finding the right match with the Images</span>
            <span class="c1"># Warning, needs &gt; numpy 1.15.0</span>
            <span class="n">mjd_values</span><span class="p">,</span> <span class="n">ind_ima</span><span class="p">,</span> <span class="n">ind_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">intersect1d</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">ima_mjdobs</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">table_mjdobs</span><span class="p">,</span>
                    <span class="n">return_indices</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">assume_unique</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="c1"># Extracting the flux scale from table</span>
            <span class="n">nonan_flux_scale_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                    <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="p">[</span><span class="s1">&#39;FLUX_SCALE&#39;</span><span class="p">]),</span> 
                    <span class="mf">1.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="p">[</span><span class="s1">&#39;FLUX_SCALE&#39;</span><span class="p">])</span>
            <span class="c1"># Extracting the rotangle, but only if there</span>
            <span class="n">rotangle_exist</span> <span class="o">=</span> <span class="kc">False</span>
            <span class="k">if</span> <span class="p">(</span><span class="s1">&#39;ROTANGLE&#39;</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="o">.</span><span class="n">columns</span><span class="p">):</span>
                <span class="n">nonan_rotangle_table</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]),</span> 
                        <span class="mf">0.</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">])</span>
                <span class="n">rotangle_exist</span> <span class="o">=</span> <span class="kc">True</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">rotangle_exist</span><span class="p">:</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Rotation angles not present in offset table.&quot;</span>
                                    <span class="s2">&quot;Please use argument &#39;rotation&#39; in &#39;run&#39; &quot;</span>
                                    <span class="s2">&quot;to force a non zero value.&quot;</span><span class="p">)</span>

            <span class="c1"># Loop over the images, using MJD</span>
            <span class="k">for</span> <span class="n">nima</span><span class="p">,</span> <span class="n">mjd</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ima_mjdobs</span><span class="p">):</span>
                <span class="c1"># Test if mjd is in the set of mjd_values</span>
                <span class="k">if</span> <span class="n">mjd</span> <span class="ow">in</span> <span class="n">mjd_values</span><span class="p">:</span>
                    <span class="c1"># Find the index of the value array where mjd</span>
                    <span class="n">ind</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nonzero</span><span class="p">(</span><span class="n">mjd_values</span> <span class="o">==</span> <span class="n">mjd</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="p">[</span><span class="s1">&#39;RA_OFFSET&#39;</span><span class="p">][</span><span class="n">ind_table</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span> <span class="o">*</span> <span class="mf">3600.</span> \
                                    <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_dec_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">])),</span>
                            <span class="bp">self</span><span class="o">.</span><span class="n">offset_table</span><span class="p">[</span><span class="s1">&#39;DEC_OFFSET&#39;</span><span class="p">][</span><span class="n">ind_table</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span> <span class="o">*</span> <span class="mf">3600.</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_flux_scale</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonan_flux_scale_table</span><span class="p">[</span><span class="n">ind_table</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span>
                    <span class="k">if</span> <span class="n">rotangle_exist</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">init_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">nonan_rotangle_table</span><span class="p">[</span><span class="n">ind_table</span><span class="p">[</span><span class="n">ind</span><span class="p">]]</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">init_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
                <span class="c1"># Otherwise use default values</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_flux_scale</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">init_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

                <span class="c1"># Transform into pixel values</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">init_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">arcsec_to_pixel</span><span class="p">(</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">init_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">])</span></div>

    <span class="k">def</span> <span class="nf">_reset_init_guess_values</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Reset the initial guess to 0. Hidden function as this is only</span>
<span class="sd">        used internally</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">table_mjdobs</span> <span class="o">=</span> <span class="p">[</span><span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_off_pixel</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_off_arcsec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">,</span> <span class="mi">2</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_flux_scale</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">init_rotangles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">)</span>

<div class="viewcode-block" id="AlignMusePointing.open_offset_table"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.open_offset_table">[docs]</a>    <span class="k">def</span> <span class="nf">open_offset_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Read offset table from fits file</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        name_table: str</span>
<span class="sd">            Name of the input OFFSET table</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        status: None if no table name is given, False if file does not</span>
<span class="sd">            exist, True if it does</span>
<span class="sd">        Table: the result of a astropy.Table.read of the fits table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;name_table&quot;</span><span class="p">):</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;No FITS table name provided, &quot;</span>
                                  <span class="s2">&quot;Aborting Open&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="kc">None</span><span class="p">,</span> <span class="n">Table</span><span class="p">()</span>

        <span class="k">if</span> <span class="ow">not</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">isfile</span><span class="p">(</span><span class="n">name_table</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;FITS Table (</span><span class="si">{0}</span><span class="s2">) does not &quot;</span>
                <span class="s2">&quot; exist yet&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_table</span><span class="p">))</span>
            <span class="k">return</span> <span class="kc">False</span><span class="p">,</span> <span class="n">Table</span><span class="p">()</span>

        <span class="k">return</span> <span class="kc">True</span><span class="p">,</span> <span class="n">Table</span><span class="o">.</span><span class="n">read</span><span class="p">(</span><span class="n">name_table</span><span class="p">)</span></div>

<div class="viewcode-block" id="AlignMusePointing.print_offset_fromfits"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.print_offset_fromfits">[docs]</a>    <span class="k">def</span> <span class="nf">print_offset_fromfits</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_table</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print offset table from fits file</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        name_table: str</span>
<span class="sd">            Name of the input OFFSET table</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">exist_table</span><span class="p">,</span> <span class="n">fits_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_offset_table</span><span class="p">(</span><span class="n">name_table</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">exist_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="p">((</span><span class="s1">&#39;RA_OFFSET&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span> 
                <span class="ow">or</span> <span class="p">(</span><span class="s1">&#39;DEC_OFFSET&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Table does not contain &#39;RA/DEC_OFFSET&#39; &quot;</span>
                              <span class="s2">&quot;columns, Aborting&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Offset recorded in OFFSET_LIST Table&quot;</span><span class="p">)</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Total in ARCSEC&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Image </span><span class="si">{0:03d}</span><span class="s2"> - </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">[</span><span class="n">nima</span><span class="p">]))</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;          - </span><span class="si">{0:8.4f}</span><span class="s2"> </span><span class="si">{1:8.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;RA_OFFSET&#39;</span><span class="p">][</span><span class="n">nima</span><span class="p">]</span><span class="o">*</span><span class="mi">3600</span> \
                            <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_dec_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">])),</span>
                    <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;DEC_OFFSET&#39;</span><span class="p">][</span><span class="n">nima</span><span class="p">]</span><span class="o">*</span><span class="mf">3600.</span><span class="p">))</span></div>

<div class="viewcode-block" id="AlignMusePointing.print_images_names"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.print_images_names">[docs]</a>    <span class="k">def</span> <span class="nf">print_images_names</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print out the names of the images being considered for alignment</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Image names&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2"> - </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">[</span><span class="n">nima</span><span class="p">]))</span></div>

<div class="viewcode-block" id="AlignMusePointing.print_offset"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.print_offset">[docs]</a>    <span class="k">def</span> <span class="nf">print_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Print out the offset from the Alignment class</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;#---- Offset recorded so far ----#&quot;</span><span class="p">)</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;#    Name               OFFSETS  |ARCSEC|   &quot;</span>
                         <span class="s2">&quot;X        Y     |PIXEL|    X        Y      |ROT| (DEG)&quot;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">):</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0:03d}</span><span class="s2"> -</span><span class="si">{1:&gt;26}</span><span class="s2">  |ARCSEC|</span><span class="si">{2:8.4f}</span><span class="s2"> </span><span class="si">{3:8.4f}</span><span class="s2"> &quot;</span>
                             <span class="s2">&quot; |PIXEL|</span><span class="si">{4:8.4f}</span><span class="s2"> </span><span class="si">{5:8.4f}</span><span class="s2">  |ROT|</span><span class="si">{6:8.4f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                             <span class="n">nima</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="o">-</span><span class="mi">29</span><span class="p">:</span><span class="o">-</span><span class="mi">5</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                             <span class="bp">self</span><span class="o">.</span><span class="n">_total_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">]))</span></div>

<div class="viewcode-block" id="AlignMusePointing.save_fits_offset_table"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.save_fits_offset_table">[docs]</a>    <span class="k">def</span> <span class="nf">save_fits_offset_table</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">name_output_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> 
            <span class="n">folder_output_table</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span>
            <span class="n">overwrite</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">suffix</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">,</span> <span class="n">save_flux_scale</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
            <span class="n">save_other_params</span><span class="o">=</span><span class="kc">True</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the Offsets into a fits Table</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        folder_output_table: str [None]</span>
<span class="sd">            Folder of the output table. If None (default) the folder</span>
<span class="sd">            for the input offset table will be used or alternatively</span>
<span class="sd">            the folder of the MUSE images.</span>
<span class="sd">        name_output_table: str [None]</span>
<span class="sd">            Name of the output fits table. If None (default) it will</span>
<span class="sd">            use the one given in self.name_output_table</span>
<span class="sd">        overwrite: bool [False]</span>
<span class="sd">            If True, overwrite if the file exists</span>
<span class="sd">        suffix: str [&quot;&quot;]</span>
<span class="sd">            Suffix to be used to add to the input name. This is handy</span>
<span class="sd">            to just modify the given fits name with a suffix </span>
<span class="sd">            (e.g., version number).</span>
<span class="sd">        save_flux_scale: bool</span>
<span class="sd">            If True (default), saving the flux in FLUX_SCALE</span>
<span class="sd">            If False, do not save the flux conversion</span>
<span class="sd">        save_other_params: bool</span>
<span class="sd">            If True (default), saving the background + rotation</span>
<span class="sd">            If False, do not save these 2 parameters.</span>
<span class="sd">        </span>
<span class="sd">        Creates</span>
<span class="sd">        -------</span>
<span class="sd">        A fits table with the given name (using the suffix if any)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">name_output_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span> 
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_offset_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">name_output_table</span> <span class="o">=</span> <span class="s2">&quot;DUMMY_OFFSET_TABLE.fits&quot;</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">name_output_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_offset_table</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">suffix</span> <span class="o">=</span> <span class="n">suffix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_output_table</span> <span class="o">=</span> <span class="n">name_output_table</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s2">&quot;.fits&quot;</span><span class="p">,</span> 
                <span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">.fits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">suffix</span><span class="p">))</span>

        <span class="k">if</span> <span class="n">folder_output_table</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">folder_output_table</span> <span class="o">=</span> <span class="n">folder_output_table</span>
        <span class="n">exist_table</span><span class="p">,</span> <span class="n">fits_table</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">open_offset_table</span><span class="p">(</span>
               <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_output_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_output_table</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">exist_table</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Save is aborted&quot;</span><span class="p">)</span>
            <span class="k">return</span>

        <span class="c1"># Checking if overwrite and exist_table do go together</span>
        <span class="k">if</span> <span class="n">exist_table</span> <span class="ow">and</span> <span class="ow">not</span> <span class="n">overwrite</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Table already exists, &quot;</span>
                                <span class="s2">&quot;but overwrite is set to False&quot;</span><span class="p">)</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;If you wish to overwrite the table </span><span class="si">{0}</span><span class="s2">, &quot;</span>
                    <span class="s2">&quot;please set overwrite to True&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">name_output_table</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="c1"># Check if RA_OFFSET is there</span>
        <span class="n">exist_ra_offset</span> <span class="o">=</span>  <span class="p">(</span><span class="s1">&#39;RA_OFFSET&#39;</span> <span class="ow">in</span> <span class="n">fits_table</span><span class="o">.</span><span class="n">columns</span><span class="p">)</span>

        <span class="c1"># First save the DATA and MJD references</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="n">date_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_dateobs</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_mjdobs</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="n">tpl_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_tplstart</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="n">iexpo_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_iexpo</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="n">pointing_names</span><span class="p">[</span><span class="s1">&#39;table&#39;</span><span class="p">]]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_pointing</span>

        <span class="c1"># Saving the final values</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;RA_OFFSET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_arcsec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3600.</span> \
                <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_dec_muse</span><span class="p">))</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;DEC_OFFSET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_arcsec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3600.</span>
        <span class="k">if</span> <span class="n">save_flux_scale</span><span class="p">:</span>
            <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;FLUX_SCALE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;FLUX_SCALE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="mf">1.0</span>
        <span class="k">if</span> <span class="n">save_other_params</span><span class="p">:</span>
            <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;BACKGROUND&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_background</span>
            <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;ROTANGLE&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_rotangles</span>

        <span class="c1"># Deal with RA_OFFSET_ORIG if needed</span>
        <span class="k">if</span> <span class="n">exist_ra_offset</span><span class="p">:</span>
            <span class="c1"># if RA_OFFSET exists, then check if the ORIG column is there</span>
            <span class="k">if</span> <span class="s1">&#39;RA_OFFSET_ORIG&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">fits_table</span><span class="o">.</span><span class="n">columns</span><span class="p">:</span>
                <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;RA_OFFSET_ORIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;RA_OFFSET&#39;</span><span class="p">]</span>
                <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;DEC_OFFSET_ORIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;DEC_OFFSET&#39;</span><span class="p">]</span>
                <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;FLUX_SCALE_ORIG&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;FLUX_SCALE&#39;</span><span class="p">]</span>

        <span class="c1"># Finally add the cross-correlation offsets</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;RA_CROSS_OFFSET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_arcsec</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3600.</span>  \
                <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_dec_muse</span><span class="p">))</span>
        <span class="n">fits_table</span><span class="p">[</span><span class="s1">&#39;DEC_CROSS_OFFSET&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_arcsec</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">/</span> <span class="mf">3600.</span>

        <span class="c1"># Writing up</span>
        <span class="n">fits_table</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_output_table</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_output_table</span><span class="p">),</span> 
                         <span class="n">overwrite</span><span class="o">=</span><span class="n">overwrite</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">name_output_table</span> <span class="o">=</span> <span class="n">name_output_table</span></div>

<div class="viewcode-block" id="AlignMusePointing.run"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.run">[docs]</a>    <span class="k">def</span> <span class="nf">run</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nima</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the offset and comparison</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        nima: int</span>
<span class="sd">            Index of the image to consider</span>
<span class="sd">        extra_pixel: list of 2 floats [0,0]</span>
<span class="sd">            Offsets in X and Y in pixels to add to the existing</span>
<span class="sd">            guessed offsets</span>
<span class="sd">            IMPORTANT NOTE: extra_pixel will be considered first</span>
<span class="sd">            (before extra_arcsec).</span>
<span class="sd">        extra_arcsec: list of 2 floats [0,0]</span>
<span class="sd">            Offsets in X and Y in arcsec to add to the existing</span>
<span class="sd">            guessed offsets. Ignored if extra_pixel is given.</span>
<span class="sd">        extra_rotation: rotation in degrees [0]</span>
<span class="sd">            Angle to rotate the image (in degrees)</span>
<span class="sd">        threshold_muse: float [0]</span>
<span class="sd">            Threshold to consider when plotting the comparison</span>

<span class="sd">        Additional arguments</span>
<span class="sd">        --------------------</span>
<span class="sd">        plot (bool): if True, will plot the comparison</span>
<span class="sd">            If not used, will use the default self.plot</span>
<span class="sd">               * flux comparison (1 to 1)</span>
<span class="sd">               * Map of the flux ratio</span>
<span class="sd">               * Contours of the two scaled maps</span>
<span class="sd">               * Cuts of the division between the 2 maps</span>

<span class="sd">        See also all arguments from self.compare</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">nima</span> <span class="ow">not</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">)</span> <span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;nima not within the range &quot;</span>
                              <span class="s2">&quot;allowed by self.nimages (</span><span class="si">{0}</span><span class="s2">)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">))</span>
            <span class="k">return</span>

        <span class="k">if</span> <span class="s2">&quot;extra_pixel&quot;</span> <span class="ow">in</span> <span class="n">kwargs</span><span class="p">:</span>
            <span class="n">extra_pixel</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;extra_pixel&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>
            <span class="n">extra_arcsec</span> <span class="o">=</span> <span class="n">pixel_to_arcsec</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span> 
                                           <span class="n">extra_pixel</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">extra_arcsec</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;extra_arcsec&quot;</span><span class="p">,</span> <span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">])</span>

        <span class="c1"># Define the additional rotation angle</span>
        <span class="n">extra_rotangle</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;extra_rotation&quot;</span><span class="p">,</span> <span class="mf">0.0</span><span class="p">)</span>

        <span class="c1"># Add the offset from user</span>
        <span class="n">border</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;border&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border</span><span class="p">)</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift_arcsecond</span><span class="p">(</span><span class="n">extra_arcsec</span><span class="p">,</span> <span class="n">extra_rotangle</span><span class="p">,</span> <span class="n">nima</span><span class="p">,</span>
                             <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="c1"># Compare contours if plot is set to True</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">compare</span><span class="p">(</span><span class="n">nima</span><span class="o">=</span><span class="n">nima</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_list_muse_images</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Extract the name of the muse images</span>
<span class="sd">        and build the list</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="kn">from</span> <span class="nn">pathlib</span> <span class="kn">import</span> <span class="n">Path</span>

        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_muse_images</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">set_of_paths</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s2">&quot;</span><span class="si">{0}</span><span class="s2">*</span><span class="si">{1}</span><span class="s2">*.fits&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                    <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_muse_images</span><span class="p">,</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">suffix_images</span><span class="p">),</span> <span class="bp">self</span><span class="o">.</span><span class="n">filter_name</span><span class="p">))</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span> <span class="o">=</span> <span class="p">[</span><span class="n">Path</span><span class="p">(</span><span class="n">muse_path</span><span class="p">)</span><span class="o">.</span><span class="n">name</span> 
                                     <span class="k">for</span> <span class="n">muse_path</span> <span class="ow">in</span> <span class="n">set_of_paths</span><span class="p">]</span>
            <span class="c1"># Sort alphabetically</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="o">.</span><span class="n">sort</span><span class="p">()</span>
            <span class="c1"># Subselection if sel_indices_images is given</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_indices_images</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="nb">all</span><span class="p">([</span><span class="n">i</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">))</span> 
                        <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_indices_images</span><span class="p">]):</span> 
                    <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Selection list - sel_indices_images &quot;</span>
                                        <span class="s2">&quot;- does not match image list&quot;</span><span class="p">)</span>
                    <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Ignoring that input sel_indices_images&quot;</span><span class="p">)</span>
                <span class="k">else</span> <span class="p">:</span>
                    <span class="n">newlist</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> 
                            <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">sel_indices_images</span><span class="p">]</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span> <span class="o">=</span> <span class="n">newlist</span>

        <span class="c1"># test if 1 or several images</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_muse_images</span><span class="p">,</span> <span class="nb">str</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span> <span class="o">=</span> <span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">name_muse_images</span><span class="p">]</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">name_muse_images</span><span class="p">,</span> <span class="nb">list</span><span class="p">):</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">name_muse_images</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_warning</span><span class="p">(</span><span class="s2">&quot;Name of images is not a string or a list, &quot;</span>
                    <span class="s2">&quot;please check input name_muse_images&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Number of images to deal with</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">nimages</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">)</span>

<div class="viewcode-block" id="AlignMusePointing.open_hdu"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.open_hdu">[docs]</a>    <span class="k">def</span> <span class="nf">open_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the HDU of the MUSE and reference images</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">status_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_ref_hdu</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_ref</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Problem in opening Reference frame, please check input&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="n">status_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_open_muse_nhdu</span><span class="p">()</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">status_muse</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Problem in opening MUSE frame, please check input&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="mi">1</span></div>

    <span class="k">def</span> <span class="nf">_open_muse_nhdu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the MUSE images hdu</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_name_musehdr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0}{1:03d}</span><span class="s2">.hdr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name_musehdr</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_name_offmusehdr</span> <span class="o">=</span> <span class="p">[</span><span class="s2">&quot;</span><span class="si">{0}{1:03d}</span><span class="s2">.hdr&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">name_offmusehdr</span><span class="p">,</span> <span class="n">i</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_hdulist_muse</span> <span class="o">=</span> <span class="p">[</span><span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span>
                <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_muse_images</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">[</span><span class="n">i</span><span class="p">]))</span>
                <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">)]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span> <span class="o">=</span> <span class="p">[</span><span class="n">hdu</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu_ext</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span> 
                              <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_hdulist_muse</span><span class="p">]</span>
        <span class="c1"># CHANGE to mpdaf WCS</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_muse</span> <span class="o">=</span> <span class="p">[</span><span class="n">WCS</span><span class="p">(</span><span class="n">hdu</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span> 
                              <span class="k">for</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_hdulist_muse</span><span class="p">]</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_dec_muse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">muse_wcs</span><span class="o">.</span><span class="n">get_crval2</span><span class="p">()</span>
                              <span class="k">for</span> <span class="n">muse_wcs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_muse</span><span class="p">])</span>
        <span class="c1"># Getting the orientation angles</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_rotangles</span> <span class="o">=</span> <span class="p">[</span><span class="n">musewcs</span><span class="o">.</span><span class="n">get_rot</span><span class="p">()</span> 
                                    <span class="k">for</span> <span class="n">musewcs</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_muse</span><span class="p">]</span>

        <span class="c1"># Filling in the MJD and DATE OBS keywords for the MUSE images</span>
        <span class="c1"># If not there, will be filled with &quot;None&quot;</span>
        <span class="k">for</span> <span class="n">nima</span><span class="p">,</span> <span class="n">hdu</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_hdulist_muse</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">date_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_dateobs</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_dateobs</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">date_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_mjdobs</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_mjdobs</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">mjd_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">tpl_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_tplstart</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_tplstart</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">tpl_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">iexpo_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_iexpo</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_iexpo</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">iexpo_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">pointing_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_pointing</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">ima_pointing</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">hdu</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">[</span><span class="n">pointing_names</span><span class="p">[</span><span class="s1">&#39;image&#39;</span><span class="p">]]</span>


            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="mi">1</span>

    <span class="k">def</span> <span class="nf">_open_ref_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Open the reference image hdu</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Open the images</span>
        <span class="n">hdulist_reference</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">folder_reference</span><span class="p">,</span>
                                        <span class="bp">self</span><span class="o">.</span><span class="n">name_reference</span><span class="p">))</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">reference_hdu</span> <span class="o">=</span> <span class="n">hdulist_reference</span><span class="p">[</span><span class="bp">self</span><span class="o">.</span><span class="n">hdu_ext</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">reference_hdu</span><span class="o">.</span><span class="n">data</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;No data found in extension of reference frame&quot;</span><span class="p">)</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;Check your input, &quot;</span>
                    <span class="s2">&quot;or change the extention number in input hdu_ext[0]&quot;</span><span class="p">)</span>
            <span class="k">return</span> <span class="mi">0</span>

        <span class="k">return</span> <span class="mi">1</span>

<div class="viewcode-block" id="AlignMusePointing.find_ncross_peak"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.find_ncross_peak">[docs]</a>    <span class="k">def</span> <span class="nf">find_ncross_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">list_nima</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">minflux</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Run the cross correlation peaks on all MUSE images</span>
<span class="sd">        Derive the self.cross_off_pixel/arcsec parameters</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        list_nima: list of indices for images to process</span>
<span class="sd">            Should be a list. Default is None</span>
<span class="sd">            and all images are processed</span>

<span class="sd">        minflux: float [None]</span>
<span class="sd">            minimum flux to be used in the cross-correlation</span>
<span class="sd">            Flux below that value will be set to 0.</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Starting the cross-correlation for all images&quot;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">list_nima</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">list_nima</span> <span class="o">=</span> <span class="nb">range</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">nimages</span><span class="p">)</span>

        <span class="k">for</span> <span class="n">nima</span> <span class="ow">in</span> <span class="n">list_nima</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">find_cross_peak</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_name_musehdr</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span> 
                    <span class="n">rotation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">init_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                    <span class="n">minflux</span><span class="o">=</span><span class="n">minflux</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">pixel_to_arcsec</span><span class="p">(</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                    <span class="bp">self</span><span class="o">.</span><span class="n">cross_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">])</span></div>

<div class="viewcode-block" id="AlignMusePointing.find_cross_peak"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.find_cross_peak">[docs]</a>    <span class="k">def</span> <span class="nf">find_cross_peak</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">muse_hdu</span><span class="p">,</span> <span class="n">name_musehdr</span><span class="p">,</span> <span class="n">rotation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">minflux</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Aligns the MUSE HDU to a reference HDU</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        muse_hdu: MUSE hdu file</span>
<span class="sd">        name_musehdr: name of the muse hdr to save</span>
<span class="sd">        rotation: Angle in degrees (0). </span>
<span class="sd">        minflux: minimum flux to be used in the cross-correlation</span>
<span class="sd">                Flux below that value will be set to 0.</span>
<span class="sd">                Default is 0.</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        xpix_cross</span>
<span class="sd">        ypix_cross: x and y pixel coordinates of the cross-correlation peak</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Projecting the reference image onto the MUSE field</span>
        <span class="n">tmphdr</span> <span class="o">=</span> <span class="n">muse_hdu</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">totextfile</span><span class="p">(</span><span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_folder_name</span><span class="p">,</span>
                                            <span class="n">name_musehdr</span><span class="p">),</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">hdu_target</span><span class="p">,</span> <span class="n">proj_ref_hdu</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align_reference_hdu</span><span class="p">(</span><span class="n">muse_hdu</span><span class="p">,</span>
                                                             <span class="n">target_rotation</span><span class="o">=</span><span class="n">rotation</span><span class="p">)</span>

        <span class="c1"># Cleaning the images</span>
        <span class="k">if</span> <span class="n">minflux</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">minflux</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">minflux_crosscorr</span>

        <span class="n">minflux_ref</span> <span class="o">=</span> <span class="n">minflux</span> <span class="o">/</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion_factor</span>
        <span class="n">ima_ref</span> <span class="o">=</span> <span class="n">prepare_image</span><span class="p">(</span><span class="n">proj_ref_hdu</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border</span><span class="p">,</span> 
                                <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_range</span><span class="p">,</span>
                                <span class="bp">self</span><span class="o">.</span><span class="n">median_window</span><span class="p">,</span>
                                <span class="n">minflux</span><span class="o">=</span><span class="n">minflux_ref</span><span class="p">)</span> <span class="o">*</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion_factor</span>
        <span class="n">ima_muse</span> <span class="o">=</span> <span class="n">prepare_image</span><span class="p">(</span><span class="n">muse_hdu</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border</span><span class="p">,</span> 
                <span class="bp">self</span><span class="o">.</span><span class="n">dynamic_range</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">median_window</span><span class="p">,</span>
                <span class="n">minflux</span><span class="o">=</span><span class="n">minflux</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_input_origmuse_cc</span> <span class="o">=</span> <span class="n">muse_hdu</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_input_origref_cc</span> <span class="o">=</span> <span class="n">proj_ref_hdu</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="mf">1.0</span>

        <span class="c1"># Cross-correlate the images</span>
        <span class="n">ccor</span> <span class="o">=</span> <span class="n">correlate</span><span class="p">(</span><span class="n">ima_ref</span><span class="p">,</span> <span class="n">ima_muse</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;full&#39;</span><span class="p">,</span> <span class="n">method</span><span class="o">=</span><span class="s1">&#39;auto&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_debug</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_ima_muse_tocc</span> <span class="o">=</span> <span class="n">ima_muse</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_ima_ref_tocc</span> <span class="o">=</span> <span class="n">ima_ref</span> <span class="o">*</span> <span class="mf">1.0</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_cc</span> <span class="o">=</span> <span class="n">ccor</span> <span class="o">*</span> <span class="mf">1.0</span>

        <span class="c1"># Find peak of cross-correlation</span>
        <span class="n">maxy</span><span class="p">,</span> <span class="n">maxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">ccor</span><span class="p">),</span>
                                      <span class="n">ccor</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Extract a window around it</span>
        <span class="n">window</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">subim_window</span>
        <span class="n">y</span><span class="p">,</span> <span class="n">x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ix_</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">window</span> <span class="o">+</span> <span class="n">maxy</span><span class="p">,</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">maxy</span><span class="p">),</span>
                      <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="o">-</span><span class="n">window</span> <span class="o">+</span> <span class="n">maxx</span><span class="p">,</span> <span class="n">window</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">maxx</span><span class="p">))</span>
        <span class="n">subim</span> <span class="o">=</span> <span class="n">ccor</span><span class="p">[</span><span class="n">y</span> <span class="o">%</span> <span class="n">ccor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">x</span> <span class="o">%</span> <span class="n">ccor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
        <span class="n">subim</span> <span class="o">-=</span> <span class="n">subim</span><span class="o">.</span><span class="n">min</span><span class="p">()</span>
        <span class="n">mx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">subim</span><span class="p">)</span>
        <span class="n">smaxy</span><span class="p">,</span> <span class="n">smaxx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unravel_index</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">subim</span><span class="p">),</span>
                                        <span class="n">subim</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Fit a 2D Gaussian to that peak</span>
        <span class="n">gauss_init</span> <span class="o">=</span> <span class="n">models</span><span class="o">.</span><span class="n">Gaussian2D</span><span class="p">(</span><span class="n">amplitude</span><span class="o">=</span><span class="n">mx</span><span class="p">,</span>
                                       <span class="n">x_mean</span><span class="o">=</span><span class="n">x</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="n">smaxx</span><span class="p">],</span>
                                       <span class="n">y_mean</span><span class="o">=</span><span class="n">y</span><span class="p">[</span><span class="n">smaxy</span><span class="p">,</span> <span class="mi">0</span><span class="p">],</span>
                                       <span class="n">x_stddev</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="n">y_stddev</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span>
                                       <span class="n">theta</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
        <span class="n">fitter</span> <span class="o">=</span> <span class="n">fitting</span><span class="o">.</span><span class="n">LevMarLSQFitter</span><span class="p">()</span>
        <span class="n">params</span> <span class="o">=</span> <span class="n">fitter</span><span class="p">(</span><span class="n">gauss_init</span><span class="p">,</span> <span class="n">x</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">y</span><span class="p">),</span>
                        <span class="n">y</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">ones_like</span><span class="p">(</span><span class="n">x</span><span class="p">),</span>
                        <span class="n">subim</span><span class="p">)</span>

        <span class="c1"># Update Astrometry</span>
        <span class="c1"># Beware, the sign was changed here and is now ok</span>
        <span class="n">xpix_cross</span> <span class="o">=</span> <span class="n">ccor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="n">params</span><span class="o">.</span><span class="n">x_mean</span>
        <span class="n">ypix_cross</span> <span class="o">=</span> <span class="n">ccor</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">//</span><span class="mi">2</span> <span class="o">-</span> <span class="n">params</span><span class="o">.</span><span class="n">y_mean</span>

        <span class="k">return</span> <span class="n">xpix_cross</span><span class="p">,</span> <span class="n">ypix_cross</span></div>

<div class="viewcode-block" id="AlignMusePointing.save_image"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.save_image">[docs]</a>    <span class="k">def</span> <span class="nf">save_image</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">newfits_name</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">nima</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Save the newly determined hdu</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        newfits_name: str</span>
<span class="sd">            Name of the fits file to be used</span>
<span class="sd">        nima: int [0]</span>
<span class="sd">            Index of the image to save</span>

<span class="sd">        Creates</span>
<span class="sd">        -------</span>
<span class="sd">        A new fits file</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="nb">hasattr</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="s2">&quot;list_offmuse_hdu&quot;</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">newfits_name</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">newfits_name</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_name_museimages</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
                        <span class="s2">&quot;.fits&quot;</span><span class="p">,</span> <span class="s2">&quot;_shift.fits&quot;</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">writeto</span><span class="p">(</span><span class="n">newfits_name</span><span class="p">,</span> <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">upipe</span><span class="o">.</span><span class="n">print_error</span><span class="p">(</span><span class="s2">&quot;There are not yet any new hdu to save&quot;</span><span class="p">)</span></div>

    <span class="k">def</span> <span class="nf">_get_flux_range</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">data</span><span class="p">,</span> <span class="n">low</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">high</span><span class="o">=</span><span class="mi">99</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the range of fluxes within the array</span>
<span class="sd">        by looking at percentiles.</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        data: 2d array</span>
<span class="sd">            Input array with signal to process</span>
<span class="sd">        low, high: two floats (10, 99)</span>
<span class="sd">            Percentiles to consider to filter</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        lperc, hperc: 2 floats</span>
<span class="sd">            Low and high percentiles</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Omit the border pixels</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border</span><span class="p">)</span>

        <span class="c1"># Clean up the NaNs</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">lperc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">low</span><span class="p">)</span>
        <span class="n">hperc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">percentile</span><span class="p">(</span><span class="n">data</span><span class="p">[</span><span class="n">data</span> <span class="o">&gt;</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">high</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">lperc</span><span class="p">,</span> <span class="n">hperc</span>

    <span class="k">def</span> <span class="nf">_align_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdu_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">hdu_to_align</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_rotation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                   <span class="n">to_align_rotation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span> <span class="n">conversion</span><span class="o">=</span><span class="kc">False</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Project the reference image onto the MUSE field</span>
<span class="sd">        Hidden function, as only used internally</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        muse_hdu: HDU [None]</span>
<span class="sd">            Input hdu</span>
<span class="sd">        hdu_ref: HDU [None]</span>
<span class="sd">        to_align_rotation: float [0]</span>
<span class="sd">            Rotation angle in degrees</span>
<span class="sd">        target_rotation: float [0]</span>
<span class="sd">            Rotation angle in degrees</span>

<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hdu_repr: HDU</span>
<span class="sd">            Reprojected HDU. None if nothing is provided</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># The mpdaf way to project an image onto an other one</span>
        <span class="c1"># WARNING: the reference image will be converted in flux</span>
        <span class="k">if</span> <span class="n">conversion</span><span class="p">:</span>
            <span class="n">conversion_factor</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">conversion_factor</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">conversion_factor</span> <span class="o">=</span> <span class="mf">1.0</span>

        <span class="k">if</span> <span class="n">hdu_target</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span> <span class="ow">and</span> <span class="n">hdu_to_align</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="c1"># Getting the reference image data and WCS</span>
            <span class="n">wcs_to_align</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">hdu_to_align</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">to_align_rotation</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">wcs_to_align</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">to_align_rotation</span><span class="p">)</span>
            <span class="n">ima_to_align</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">hdu_to_align</span><span class="o">.</span><span class="n">data</span> <span class="o">*</span> <span class="n">conversion_factor</span><span class="p">,</span>
                                 <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_to_align</span><span class="p">)</span>

            <span class="c1"># Getting the MUSE image data and WCS</span>
            <span class="n">wcs_target</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span><span class="n">hdr</span><span class="o">=</span><span class="n">hdu_target</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">target_rotation</span> <span class="o">!=</span> <span class="mf">0.</span><span class="p">:</span>
                <span class="n">wcs_target</span><span class="o">.</span><span class="n">rotate</span><span class="p">(</span><span class="o">-</span><span class="n">target_rotation</span><span class="p">)</span>
            <span class="n">ima_target</span> <span class="o">=</span> <span class="n">Image</span><span class="p">(</span><span class="n">data</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan_to_num</span><span class="p">(</span><span class="n">hdu_target</span><span class="o">.</span><span class="n">data</span><span class="p">),</span>
                               <span class="n">wcs</span><span class="o">=</span><span class="n">wcs_target</span><span class="p">)</span>
            <span class="n">hdu_target</span> <span class="o">=</span> <span class="n">ima_target</span><span class="o">.</span><span class="n">get_data_hdu</span><span class="p">()</span>

            <span class="c1"># Aligning the reference image with the MUSE image using mpdaf</span>
            <span class="c1"># align_with_image</span>
            <span class="n">ima_aligned</span> <span class="o">=</span> <span class="n">ima_to_align</span><span class="o">.</span><span class="n">align_with_image</span><span class="p">(</span><span class="n">ima_target</span><span class="p">,</span> <span class="n">flux</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
            <span class="n">hdu_aligned</span> <span class="o">=</span> <span class="n">ima_aligned</span><span class="o">.</span><span class="n">get_data_hdu</span><span class="p">()</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="n">hdu_aligned</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Warning: please provide target HDU to allow reprojection&quot;</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">hdu_target</span><span class="p">,</span> <span class="n">hdu_aligned</span>

    <span class="k">def</span> <span class="nf">_align_reference_hdu</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">hdu_target</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">target_rotation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">,</span>
                             <span class="n">ref_rotation</span><span class="o">=</span><span class="mf">0.0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Project the reference image onto the MUSE field</span>
<span class="sd">        Hidden function, as only used internally</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        muse_hdu: HDU [None]</span>
<span class="sd">            Input hdu</span>
<span class="sd">        rotation: float [0]</span>
<span class="sd">            Rotation angle in degrees</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        hdu_repr: HDU</span>
<span class="sd">            Reprojected HDU. None if nothing is provided</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align_hdu</span><span class="p">(</span><span class="n">hdu_target</span><span class="o">=</span><span class="n">hdu_target</span><span class="p">,</span>
                               <span class="n">target_rotation</span><span class="o">=</span><span class="n">target_rotation</span><span class="p">,</span>
                               <span class="n">to_align_rotation</span><span class="o">=</span><span class="n">ref_rotation</span><span class="p">,</span>
                               <span class="n">hdu_to_align</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">reference_hdu</span><span class="p">,</span>
                               <span class="n">conversion</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_total_rotangles</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_rotangles</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_rotangles</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_total_off_pixel</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_off_pixel</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_off_pixel</span>

    <span class="nd">@property</span>
    <span class="k">def</span> <span class="nf">_total_off_arcsec</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">init_off_arcsec</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">extra_off_arcsec</span>

    <span class="k">def</span> <span class="nf">_add_user_arc_offset</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_arcsec</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span>
                             <span class="n">extra_rotation</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">nima</span><span class="o">=</span><span class="mi">0</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Add user offset in arcseconds and transform into pixels</span>

<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        extra_arcsec: list of 2 floats [0,0]</span>
<span class="sd">            Extra offsets (x,y) in arcseconds</span>
<span class="sd">        extra_rotation: rotation in degrees [0]</span>
<span class="sd">        nima: int</span>
<span class="sd">            Index of image to consider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Transforming the arc into pix</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_arcsec</span>
        <span class="c1"># Transforming into pixels - would be better with setter</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">arcsec_to_pixel</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">extra_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">])</span>
        <span class="c1"># And the rotation angle in degrees</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">extra_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">extra_rotation</span>

<div class="viewcode-block" id="AlignMusePointing.shift_arcsecond"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.shift_arcsecond">[docs]</a>    <span class="k">def</span> <span class="nf">shift_arcsecond</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">extra_arcsec</span><span class="o">=</span><span class="p">[</span><span class="mf">0.</span><span class="p">,</span> <span class="mf">0.</span><span class="p">],</span> <span class="n">extra_rotation</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">nima</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                        <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Shift image with index nima with the total offset</span>
<span class="sd">        after adding any extra given offset</span>
<span class="sd">        This does not return anything but could in principle</span>
<span class="sd">        if using the output of the self.shift</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        extra_arcsec: list of 2 floats [0,0]</span>
<span class="sd">            Extra offsets (x,y) in arcseconds</span>
<span class="sd">        extra_rotation: rotation in degrees [0]</span>
<span class="sd">        nima: int</span>
<span class="sd">            Index of image to consider</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_add_user_arc_offset</span><span class="p">(</span><span class="n">extra_arcsec</span><span class="p">,</span> <span class="n">extra_rotation</span><span class="p">,</span> <span class="n">nima</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">shift</span><span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AlignMusePointing.shift"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.shift">[docs]</a>    <span class="k">def</span> <span class="nf">shift</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nima</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Create New HDU after shifting it with the right offset</span>
<span class="sd">        (only considering image with index nima)</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        nima: int</span>
<span class="sd">            Index of image to consider</span>
<span class="sd">        </span>
<span class="sd">        Does not return anything, but could in principle</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># Create a new Header</span>
        <span class="n">newhdr</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># Shift the HDU in X and Y</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Image </span><span class="si">{0:03d}</span><span class="s2"> - </span><span class="si">{1}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_images</span><span class="p">[</span><span class="n">nima</span><span class="p">]))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Shifting CRPIX1 by </span><span class="si">{0:8.4f}</span><span class="s2"> pixels &quot;</span>
                  <span class="s2">&quot;/ </span><span class="si">{1:8.4f}</span><span class="s2"> arcsec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">0</span><span class="p">]))</span>
        <span class="n">newhdr</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newhdr</span><span class="p">[</span><span class="s1">&#39;CRPIX1&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;         CRPIX2 by </span><span class="si">{0:8.4f}</span><span class="s2"> pixels &quot;</span>
                  <span class="s2">&quot;/ </span><span class="si">{1:8.4f}</span><span class="s2"> arcsec&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span>
                      <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_arcsec</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">1</span><span class="p">]))</span>
        <span class="n">newhdr</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">newhdr</span><span class="p">[</span><span class="s1">&#39;CRPIX2&#39;</span><span class="p">]</span> <span class="o">+</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_off_pixel</span><span class="p">[</span><span class="n">nima</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Creating a new Primary HDU with the input data, and the new Header</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">pyfits</span><span class="o">.</span><span class="n">PrimaryHDU</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_muse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="n">header</span><span class="o">=</span><span class="n">newhdr</span><span class="p">)</span>
        <span class="c1"># Now reading the WCS of that new HDU and saving it in the list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># Writing this up in an ascii file for record purposes</span>
        <span class="n">tmphdr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="o">.</span><span class="n">totextfile</span><span class="p">(</span>
                <span class="n">joinpath</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">header_folder_name</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_name_offmusehdr</span><span class="p">[</span><span class="n">nima</span><span class="p">]),</span> 
                <span class="n">overwrite</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

        <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Image </span><span class="si">{0:03d}</span><span class="s2"> Rotation of </span><span class="si">{1}</span><span class="s2"> will be applied&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span>
                            <span class="n">nima</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">_total_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">]))</span>
        <span class="c1"># Reprojecting the Reference image onto the new MUSE frame</span>
        <span class="n">hdu_target</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_proj_refhdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align_reference_hdu</span><span class="p">(</span>
                <span class="n">hdu_target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                <span class="n">target_rotation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">])</span>
        <span class="c1"># Now reading the WCS and saving it in the list</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_wcs_proj_refhdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">WCS</span><span class="p">(</span>
                <span class="bp">self</span><span class="o">.</span><span class="n">list_proj_refhdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># Getting the normalisation factors again</span>
        <span class="n">musedata</span><span class="p">,</span> <span class="n">refdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_normfactor</span><span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">)</span></div>

<div class="viewcode-block" id="AlignMusePointing.get_image_normfactor"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.get_image_normfactor">[docs]</a>    <span class="k">def</span> <span class="nf">get_image_normfactor</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">nima</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">median_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> 
            <span class="n">convolve_muse</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">convolve_reference</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
            <span class="n">threshold_muse</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Get the normalisation factor for image nima</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        nima: int</span>
<span class="sd">            Index of image to consider</span>
<span class="sd">        median_filter: bool</span>
<span class="sd">            If True, will median filter</span>
<span class="sd">        convolve_muse: float [0]</span>
<span class="sd">            Will convolve the image with index nima</span>
<span class="sd">            with a gaussian with that sigma. 0 means no convolution</span>
<span class="sd">        convolve_reference: float [0]</span>
<span class="sd">            Will convolve the reference image</span>
<span class="sd">            with a gaussian with that sigma. 0 means no convolution</span>
<span class="sd">        threshold_muse: float [None]</span>
<span class="sd">            Threshold for the input image flux to consider</span>
<span class="sd">        </span>
<span class="sd">        Returns</span>
<span class="sd">        -------</span>
<span class="sd">        data: 2d array</span>
<span class="sd">        refdata: 2d array</span>
<span class="sd">            The 2 arrays (input, reference) after processing</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="c1"># If median filter do the filtermed_image process including the border</span>
        <span class="c1"># Both for the muse data and the reference data</span>
        <span class="c1"># No cropping here</span>
        <span class="k">if</span> <span class="n">median_filter</span><span class="p">:</span>
            <span class="n">musedata</span> <span class="o">=</span> <span class="n">filtermed_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">refdata</span> <span class="o">=</span> <span class="n">filtermed_image</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_proj_refhdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
        <span class="c1"># Otherwise just copy the data</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">musedata</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">data</span><span class="p">)</span>
            <span class="n">refdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">list_proj_refhdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">data</span>

        <span class="c1"># Smoothing out the result in case it is needed</span>
        <span class="k">if</span> <span class="n">convolve_muse</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="n">convolve_muse</span><span class="p">)</span>
            <span class="n">musedata</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">musedata</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">convolve_muse</span>
        <span class="k">if</span> <span class="n">convolve_reference</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
            <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="n">convolve_reference</span><span class="p">)</span>
            <span class="n">refdata</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_reference</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">convolve_reference</span>

        <span class="c1"># Getting the result of the normalisation</span>
        <span class="k">if</span> <span class="n">threshold_muse</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">threshold_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">threshold_muse</span>

        <span class="c1"># Cropping the data</span>
        <span class="n">border</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;border&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border</span><span class="p">)</span>
        <span class="n">musedataC</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">musedata</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>
        <span class="n">refdataC</span> <span class="o">=</span> <span class="n">crop_data</span><span class="p">(</span><span class="n">refdata</span><span class="p">,</span> <span class="n">border</span><span class="p">)</span>

        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="n">get_image_norm_poly</span><span class="p">(</span><span class="n">musedataC</span><span class="p">,</span>
                        <span class="n">refdataC</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">,</span>
                        <span class="n">threshold1</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">threshold_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">])</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">use_polynorm</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ima_norm_factors</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">ima_background</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

        <span class="c1"># Returning the uncropped data</span>
        <span class="k">return</span> <span class="n">musedata</span><span class="p">,</span> <span class="n">refdata</span></div>

<div class="viewcode-block" id="AlignMusePointing.compare"><a class="viewcode-back" href="../../api/pymusepipe.html#pymusepipe.align_pipe.AlignMusePointing.compare">[docs]</a>    <span class="k">def</span> <span class="nf">compare</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">start_nfig</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">nlevels</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">levels</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">convolve_muse</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span>
                <span class="n">convolve_reference</span><span class="o">=</span><span class="mf">0.</span><span class="p">,</span> <span class="n">samecontour</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">nima</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span>
                <span class="n">showcontours</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showcuts</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">shownormalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">showdiff</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                <span class="n">normalise</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">median_filter</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">ncuts</span><span class="o">=</span><span class="mi">5</span><span class="p">,</span> <span class="n">percentage</span><span class="o">=</span><span class="mf">5.</span><span class="p">,</span>
                <span class="n">nima_museref</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="o">**</span><span class="n">kwargs</span><span class="p">):</span>
        <span class="sd">&quot;&quot;&quot;Compare the projected reference and MUSE image</span>
<span class="sd">        by plotting the contours, the difference and vertical/horizontal cuts.</span>
<span class="sd">         </span>
<span class="sd">        Input</span>
<span class="sd">        -----</span>
<span class="sd">        nima: int</span>
<span class="sd">            Index of image to consider</span>
<span class="sd">        showcontours: bool [True]</span>
<span class="sd">        showcuts: bool [True]</span>
<span class="sd">        shownormalise: bool [True]</span>
<span class="sd">        showdiff: bool [True]</span>
<span class="sd">            All options corresponding to 1 specific plot. By default</span>
<span class="sd">            show them all (all True)</span>
<span class="sd">        ncuts: int [5]</span>
<span class="sd">            Number of vertical / horizontal cuts along the ratio</span>
<span class="sd">            between the 2 maps to be shown (&quot;cuts&quot;)</span>
<span class="sd">        percentage: float [5]</span>
<span class="sd">            Used to compute which percentile to show</span>
<span class="sd">        start_nfig: int [1]</span>
<span class="sd">            Number of the matplotlib Figure to start with</span>
<span class="sd">        nlevels: int [10]</span>
<span class="sd">            Number of levels for the contour plots</span>
<span class="sd">        levels: list of float [None]</span>
<span class="sd">            Specific list of levels if any (default is None)</span>
<span class="sd">        convolve_muse: float [0]</span>
<span class="sd">            If not 0, will convolve with a gaussian of that sigma</span>
<span class="sd">        convolve_reference: float [0]</span>
<span class="sd">            If not 0, will convolve the reference image</span>
<span class="sd">            with a gaussian of that sigma</span>
<span class="sd">        samecontour: bool [True]</span>
<span class="sd">            If True, will use the same levels for both images</span>
<span class="sd">            (this is recommended). Otherwise levels can be</span>
<span class="sd">            automatically derived from percentiles, but will</span>
<span class="sd">            not necessarily be the same (which can bring</span>
<span class="sd">            confusion but may sometimes be useful).</span>
<span class="sd">        nima_museref</span>
<span class="sd">        </span>
<span class="sd">        Makes a maximum of 4 figures</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">threshold_muse</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;threshold_muse&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">threshold_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">])</span>
        <span class="n">border</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;border&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">border</span><span class="p">)</span>
        <span class="n">chunk_size</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;chunk_size&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="c1"># Getting the data</span>
        <span class="n">musedata</span><span class="p">,</span> <span class="n">refdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">get_image_normfactor</span><span class="p">(</span><span class="n">nima</span><span class="o">=</span><span class="n">nima</span><span class="p">,</span> 
                                <span class="n">median_filter</span><span class="o">=</span><span class="n">median_filter</span><span class="p">,</span>
                                <span class="n">convolve_muse</span><span class="o">=</span><span class="n">convolve_muse</span><span class="p">,</span>
                                <span class="n">convolve_reference</span><span class="o">=</span><span class="n">convolve_reference</span><span class="p">,</span>
                                <span class="n">threshold_muse</span><span class="o">=</span><span class="n">threshold_muse</span><span class="p">,</span>
                                <span class="n">border</span><span class="o">=</span><span class="n">border</span><span class="p">,</span> <span class="n">chunk_size</span><span class="o">=</span><span class="n">chunk_size</span><span class="p">)</span>

        <span class="c1"># Getting data from the MUSE ref image if one is given</span>
        <span class="n">museref</span> <span class="o">=</span> <span class="n">nima_museref</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span>
        <span class="k">if</span> <span class="n">museref</span><span class="p">:</span>
            <span class="c1"># Projecting the MUSE image onto the MUSE reference</span>
            <span class="n">musehduR</span><span class="p">,</span> <span class="n">musehduC</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_align_hdu</span><span class="p">(</span><span class="n">hdu_to_align</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                                       <span class="n">target_rotation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_rotangles</span><span class="p">[</span><span class="n">nima_museref</span><span class="p">],</span>
                                       <span class="n">to_align_rotation</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_total_rotangles</span><span class="p">[</span><span class="n">nima</span><span class="p">],</span>
                                       <span class="n">hdu_target</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima_museref</span><span class="p">],</span>
                                       <span class="n">conversion</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
            <span class="c1"># Getting the data</span>
            <span class="n">musedataR</span> <span class="o">=</span> <span class="n">filtermed_image</span><span class="p">(</span><span class="n">musehduR</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="n">musedataC</span> <span class="o">=</span> <span class="n">filtermed_image</span><span class="p">(</span><span class="n">musehduC</span><span class="o">.</span><span class="n">data</span><span class="p">,</span> <span class="mf">0.</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_muse</span><span class="p">[</span><span class="n">nima_museref</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convolve_muse</span><span class="p">[</span><span class="n">nima_museref</span><span class="p">])</span>
                <span class="n">musedataR</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">musedataR</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">_convolve_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="p">:</span>
                <span class="n">kernel</span> <span class="o">=</span> <span class="n">Gaussian2DKernel</span><span class="p">(</span><span class="n">x_stddev</span><span class="o">=</span><span class="bp">self</span><span class="o">.</span><span class="n">_convolve_muse</span><span class="p">[</span><span class="n">nima</span><span class="p">])</span>
                <span class="n">musedataC</span> <span class="o">=</span> <span class="n">convolve</span><span class="p">(</span><span class="n">musedataC</span><span class="p">,</span> <span class="n">kernel</span><span class="p">)</span>

        <span class="c1"># If normalising, using the median ratio fit</span>
        <span class="k">if</span> <span class="n">normalise</span> <span class="ow">or</span> <span class="n">shownormalise</span> <span class="p">:</span>
            <span class="n">polypar</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">museref</span><span class="p">:</span>
                <span class="n">polyparR</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">ima_polypar</span><span class="p">[</span><span class="n">nima_museref</span><span class="p">]</span>

        <span class="c1"># If normalising, use the polypar slope and background</span>
        <span class="k">if</span> <span class="n">normalise</span> <span class="p">:</span>
            <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
                <span class="n">upipe</span><span class="o">.</span><span class="n">print_info</span><span class="p">(</span><span class="s2">&quot;Renormalising the MUSE data as NewMUSE = &quot;</span>
                        <span class="s2">&quot;</span><span class="si">{0:8.4e}</span><span class="s2"> * (</span><span class="si">{1:8.4e}</span><span class="s2"> + MUSE)&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">polypar</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> 
                         <span class="n">polypar</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>

            <span class="n">musedata</span> <span class="o">=</span> <span class="p">(</span><span class="n">polypar</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">musedata</span><span class="p">)</span> <span class="o">*</span> <span class="n">polypar</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">museref</span><span class="p">:</span>
                <span class="n">musedataC</span> <span class="o">=</span> <span class="p">(</span><span class="n">polypar</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">musedataC</span><span class="p">)</span> <span class="o">*</span> <span class="n">polypar</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>
                <span class="n">musedataR</span> <span class="o">=</span> <span class="p">(</span><span class="n">polyparR</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">musedataR</span><span class="p">)</span> <span class="o">*</span> <span class="n">polyparR</span><span class="o">.</span><span class="n">beta</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span>

        <span class="c1"># Getting the range of relevant fluxes</span>
        <span class="n">lowlevel_muse</span><span class="p">,</span> <span class="n">highlevel_muse</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flux_range</span><span class="p">(</span><span class="n">musedata</span><span class="p">)</span>
        <span class="n">lowlevel_ref</span><span class="p">,</span> <span class="n">highlevel_ref</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">_get_flux_range</span><span class="p">(</span><span class="n">refdata</span><span class="p">)</span>
        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">verbose</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Low / High level MUSE flux: &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{0:8.4e}</span><span class="s2"> </span><span class="si">{1:8.4e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lowlevel_muse</span><span class="p">,</span> <span class="n">highlevel_muse</span><span class="p">))</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;Low / High level REF  flux: &quot;</span>
                    <span class="s2">&quot;</span><span class="si">{0:8.4e}</span><span class="s2"> </span><span class="si">{1:8.4e}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">lowlevel_ref</span><span class="p">,</span> <span class="n">highlevel_ref</span><span class="p">))</span>

        <span class="c1"># Save the frames in case this is needed</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_refdata</span> <span class="o">=</span> <span class="n">refdata</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">_temp_musedata</span> <span class="o">=</span> <span class="n">musedata</span>
        <span class="k">if</span> <span class="n">museref</span><span class="p">:</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_musedataR</span> <span class="o">=</span> <span class="n">musedataR</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">_temp_musedataC</span> <span class="o">=</span> <span class="n">musedataC</span>

        <span class="c1"># Stop here if plot is not needed</span>
        <span class="n">plot</span> <span class="o">=</span> <span class="n">kwargs</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="s2">&quot;plot&quot;</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">plot</span><span class="p">)</span>
        <span class="k">if</span> <span class="ow">not</span> <span class="n">plot</span><span class="p">:</span>
            <span class="k">return</span>

        <span class="c1"># WCS for plotting using astropy</span>
        <span class="n">plotwcs</span> <span class="o">=</span> <span class="n">awcs</span><span class="o">.</span><span class="n">WCS</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">list_offmuse_hdu</span><span class="p">[</span><span class="n">nima</span><span class="p">]</span><span class="o">.</span><span class="n">header</span><span class="p">)</span>

        <span class="c1"># Preparing the figure</span>
        <span class="n">current_fig</span> <span class="o">=</span> <span class="n">start_nfig</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">list_figures</span> <span class="o">=</span> <span class="p">[]</span>

        <span class="c1"># Starting the plotting</span>
        <span class="k">if</span> <span class="n">shownormalise</span><span class="p">:</span>
            <span class="c1"># plotting the normalization</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">open_new_wcs_figure</span><span class="p">(</span><span class="n">current_fig</span><span class="p">)</span>
            <span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">)</span> <span class="o">=</span> <span class="p">(</span><span class="n">polypar</span><span class="o">.</span><span class="n">med</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="n">polypar</span><span class="o">.</span><span class="n">selection</span><span class="p">],</span> 
                      <span class="n">polypar</span><span class="o">.</span><span class="n">med</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="n">polypar</span><span class="o">.</span><span class="n">selection</span><span class="p">])</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">,</span> <span class="s1">&#39;.&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;MuseData&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;RefData&quot;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">my_linear_model</span><span class="p">(</span><span class="n">polypar</span><span class="o">.</span><span class="n">beta</span><span class="p">,</span> <span class="n">x</span><span class="p">),</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
            <span class="c1"># ax.plot([np.min(x), np.max(x)], [np.min(x), np.max(x)], &#39;r&#39;)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">list_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_fig</span><span class="p">)</span>
            <span class="n">current_fig</span> <span class="o">+=</span> <span class="mi">1</span>
            
        <span class="k">if</span> <span class="n">showcontours</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span> 
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">open_new_wcs_figure</span><span class="p">(</span><span class="n">current_fig</span><span class="p">,</span> <span class="n">plotwcs</span><span class="p">)</span>

            <span class="c1"># Defining the levels for MUSE</span>
            <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">levels_muse</span> <span class="o">=</span> <span class="n">levels</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">levels_muse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lowlevel_muse</span><span class="p">),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">highlevel_muse</span><span class="p">),</span> 
                                          <span class="n">nlevels</span><span class="p">)</span>
            <span class="c1"># Plot contours for MUSE</span>
            <span class="n">cmuseset</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">musedata</span><span class="p">),</span> 
                                  <span class="n">levels_muse</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span> 
                                  <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>

            <span class="c1"># now define Ref levels if not samecontour</span>
            <span class="k">if</span> <span class="n">samecontour</span><span class="p">:</span> 
                <span class="n">levels_ref</span> <span class="o">=</span> <span class="n">cmuseset</span><span class="o">.</span><span class="n">levels</span>
            <span class="k">else</span><span class="p">:</span> 
                <span class="n">levels_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lowlevel_ref</span><span class="p">),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">highlevel_ref</span><span class="p">),</span> 
                                         <span class="n">nlevels</span><span class="p">)</span>
            <span class="c1"># Plot contours for Ref</span>
            <span class="n">crefset</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">refdata</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels_ref</span><span class="p">,</span>
                                 <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">,</span> 
                                 <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">h1</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">cmuseset</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()</span>
            <span class="n">h2</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">crefset</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">h1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="s1">&#39;MUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;REF&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">nima</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Image #</span><span class="si">{0:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nima</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">list_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_fig</span><span class="p">)</span>
            <span class="n">current_fig</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">showcuts</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">open_new_wcs_figure</span><span class="p">(</span><span class="n">current_fig</span><span class="p">)</span>
            <span class="n">diffima</span> <span class="o">=</span> <span class="p">(</span><span class="n">refdata</span> <span class="o">-</span> <span class="n">musedata</span><span class="p">)</span> <span class="o">*</span> <span class="mf">200.</span> <span class="o">/</span> <span class="p">(</span><span class="n">lowlevel_muse</span> 
                      <span class="o">+</span> <span class="n">highlevel_muse</span><span class="p">)</span>
            <span class="n">chunk_x</span> <span class="o">=</span> <span class="n">musedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="n">ncuts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">chunk_y</span> <span class="o">=</span> <span class="n">musedata</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">//</span> <span class="p">(</span><span class="n">ncuts</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span>
            <span class="n">c1</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diffima</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncuts</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_x</span><span class="p">,:]</span><span class="o">.</span><span class="n">T</span><span class="p">,</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;X&#39;</span><span class="p">)</span>
            <span class="n">c2</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">diffima</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">ncuts</span><span class="p">)</span><span class="o">*</span><span class="n">chunk_y</span><span class="p">],</span> <span class="s1">&#39;r-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Y&#39;</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">(</span><span class="n">handles</span><span class="o">=</span><span class="p">[</span><span class="n">c1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">c2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="n">loc</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">20</span><span class="p">,</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s2">&quot;[pixels]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s2">&quot;[%]&quot;</span><span class="p">,</span> <span class="n">fontsize</span><span class="o">=</span><span class="mi">20</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_fig</span><span class="p">)</span>
            <span class="n">current_fig</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">showdiff</span><span class="p">:</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">open_new_wcs_figure</span><span class="p">(</span><span class="n">current_fig</span><span class="p">,</span> <span class="n">plotwcs</span><span class="p">)</span>
            <span class="n">ratio</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="p">(</span><span class="n">refdata</span> <span class="o">-</span> <span class="n">musedata</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="n">musedata</span> <span class="o">+</span> <span class="mf">1.e-12</span><span class="p">)</span>
            <span class="n">im</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">ratio</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=-</span><span class="n">percentage</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="n">percentage</span><span class="p">)</span>
            <span class="n">cbar</span> <span class="o">=</span> <span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">im</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.8</span><span class="p">)</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">list_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_fig</span><span class="p">)</span>
            <span class="n">current_fig</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="k">if</span> <span class="n">museref</span><span class="p">:</span>
            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s1">&#39;ignore&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;ignore&#39;</span><span class="p">)</span>
            <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">open_new_wcs_figure</span><span class="p">(</span><span class="n">current_fig</span><span class="p">,</span> <span class="n">plotwcs</span><span class="p">)</span>

            <span class="c1"># Defining the levels for MUSE</span>
            <span class="k">if</span> <span class="n">levels</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">levels_muse</span> <span class="o">=</span> <span class="n">levels</span>
            <span class="k">else</span> <span class="p">:</span>
                <span class="n">levels_muse</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lowlevel_muse</span><span class="p">),</span>
                                          <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">highlevel_muse</span><span class="p">),</span>
                                          <span class="n">nlevels</span><span class="p">)</span>
            <span class="c1"># Plot contours for MUSE current image</span>
            <span class="n">cmusesetC</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">musedataC</span><span class="p">),</span>
                                  <span class="n">levels_muse</span><span class="p">,</span> <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;k&#39;</span><span class="p">,</span>
                                  <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span> <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">)</span>

            <span class="c1"># now define Ref levels if not samecontour</span>
            <span class="k">if</span> <span class="n">samecontour</span><span class="p">:</span>
                <span class="n">levels_ref</span> <span class="o">=</span> <span class="n">cmusesetC</span><span class="o">.</span><span class="n">levels</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">levels_ref</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linspace</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">lowlevel_ref</span><span class="p">),</span>
                                         <span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">highlevel_ref</span><span class="p">),</span>
                                         <span class="n">nlevels</span><span class="p">)</span>
            <span class="c1"># Plot contours for Ref</span>
            <span class="n">cmusesetR</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">contour</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">log10</span><span class="p">(</span><span class="n">musedataR</span><span class="p">),</span> <span class="n">levels</span><span class="o">=</span><span class="n">levels_muse</span><span class="p">,</span>
                                   <span class="n">colors</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">,</span> <span class="n">origin</span><span class="o">=</span><span class="s1">&#39;lower&#39;</span><span class="p">,</span>
                                   <span class="n">linestyles</span><span class="o">=</span><span class="s1">&#39;solid&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

            <span class="n">ax</span><span class="o">.</span><span class="n">set_aspect</span><span class="p">(</span><span class="s1">&#39;equal&#39;</span><span class="p">)</span>
            <span class="n">h1</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">cmusesetC</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()</span>
            <span class="n">h2</span><span class="p">,</span><span class="n">_</span> <span class="o">=</span> <span class="n">cmusesetR</span><span class="o">.</span><span class="n">legend_elements</span><span class="p">()</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">legend</span><span class="p">([</span><span class="n">h1</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">h2</span><span class="p">[</span><span class="mi">0</span><span class="p">]],</span> <span class="p">[</span><span class="s1">&#39;MUSE&#39;</span><span class="p">,</span> <span class="s1">&#39;MUSEREF&#39;</span><span class="p">])</span>
            <span class="k">if</span> <span class="n">nima</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">plt</span><span class="o">.</span><span class="n">title</span><span class="p">(</span><span class="s2">&quot;Image #</span><span class="si">{0:03d}</span><span class="s2"> / #</span><span class="si">{1:03d}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">nima</span><span class="p">,</span> <span class="n">nima_museref</span><span class="p">))</span>
            <span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>

            <span class="bp">self</span><span class="o">.</span><span class="n">list_figures</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">current_fig</span><span class="p">)</span>
            <span class="n">current_fig</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="n">np</span><span class="o">.</span><span class="n">seterr</span><span class="p">(</span><span class="n">divide</span> <span class="o">=</span> <span class="s1">&#39;warn&#39;</span><span class="p">,</span> <span class="n">invalid</span><span class="o">=</span><span class="s1">&#39;warn&#39;</span><span class="p">)</span></div></div>
</pre></div>

           </div>
           
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
        &copy; Copyright 2019, Eric Emsellem

    </p>
  </div>
  Built with <a href="http://sphinx-doc.org/">Sphinx</a> using a <a href="https://github.com/rtfd/sphinx_rtd_theme">theme</a> provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>